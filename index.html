<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Robringer Social Platform - Real Usernames</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
/* 2012 ROBLOX STYLE MODIFICATIONS (Tailwind integration where possible, plus custom CSS) */
        body {
            font-family: Verdana, sans-serif;
            background: #e4e7ec; 
        }
        
        /* --- Header --- */
        header {
            background: linear-gradient(to bottom, #00A3EF 0%, #0077CC 100%);
            border-bottom: 2px solid #005696;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        
        .robux-icon {
            background-color: #ffd700;
            border: 1px solid #CC9900;
        }

        .tab { display: none; }
        .active { display: block; }

        /* --- Custom Modal Styling (Fixing alert/confirm) --- */
        .custom-modal {
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
        }
        .custom-modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        
        /* Button Gradients (Re-used from previous version) */
        .btn-primary {
            background: linear-gradient(to bottom, #00A3EF 0%, #0077CC 100%);
            border: 1px solid #005696;
            text-shadow: 0 -1px 0 rgba(0,0,0,0.2);
        }
        .btn-primary:hover {
            background: linear-gradient(to bottom, #0077CC 0%, #005696 100%);
        }
        .btn-danger {
             background: linear-gradient(to bottom, #ff5757 0%, #d93030 100%);
             border: 1px solid #a82323;
             text-shadow: 0 -1px 0 rgba(0,0,0,0.2);
        }
        .btn-danger:hover {
            background: linear-gradient(to bottom, #d93030 0%, #a82323 100%);
        }
        .btn-success {
             background: linear-gradient(to bottom, #98C72B 0%, #76A81B 100%);
             border: 1px solid #5C8315;
             text-shadow: 0 -1px 0 rgba(0,0,0,0.2);
        }
        .btn-success:hover {
            background: linear-gradient(to bottom, #76A81B 0%, #5C8315 100%);
        }

        .chat-messages {
            height: 450px; /* Fixed height for chat area */
        }
        .conversation-item.active {
            background-color: #e0f2ff;
            border-left: 4px solid #0077CC;
        }
        .nav-link.active-link {
            background-color: #005696;
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="p-2 flex justify-between items-center">
        <h1 class="text-white text-2xl font-black italic tracking-wider shadow-md">ROBRINGER</h1>
        <nav>
            <a href="#" class="nav-link text-white mx-2 p-1 font-bold rounded-t hover:bg-[#005696] active-link" data-tab="home">Home</a>
            <a href="#" class="nav-link text-white mx-2 p-1 font-bold rounded-t hover:bg-[#005696]" data-tab="games">Games</a>
            <a href="#" class="nav-link text-white mx-2 p-1 font-bold rounded-t hover:bg-[#005696]" data-tab="catalog">Catalog</a>
            <a href="#" class="nav-link text-white mx-2 p-1 font-bold rounded-t hover:bg-[#005696]" data-tab="friends">Friends</a>
            <a href="#" class="nav-link text-white mx-2 p-1 font-bold rounded-t hover:bg-[#005696]" data-tab="messages">Messages</a>
            <a href="#" class="nav-link text-white mx-2 p-1 font-bold rounded-t hover:bg-[#005696]" data-tab="profile">Profile</a>
            <a href="#" class="nav-link text-white mx-2 p-1 font-bold rounded-t hover:bg-[#005696]" data-tab="character">Character</a>
            <a href="#" class="nav-link text-white mx-2 p-1 font-bold rounded-t hover:bg-[#005696]" data-tab="forum">Forum</a>
            <a href="#" class="nav-link text-white mx-2 p-1 font-bold rounded-t hover:bg-[#005696]" data-tab="admin" id="adminLink" style="display: none;">Admin</a>
        </nav>
        <div class="flex items-center gap-4 text-white">
            <div class="robux-display flex items-center gap-1 font-bold text-[#ffd700] text-lg bg-black/20 p-1 rounded">
                <span class="robux-icon w-5 h-5 rounded-full flex items-center justify-center text-sm text-[#8B4513]">R</span>
                <span id="robuxBalance">Loading...</span>
            </div>
            <div id="loginStatusContainer">
                <span id="currentUserSpan">Loading...</span> 
            </div>
        </div>
    </header>

    <main class="content-wrapper p-5">

        <!-- Home Tab -->
        <div id="homeTab" class="tab active">
            <div class="flex flex-wrap lg:flex-nowrap gap-5 max-w-7xl mx-auto">
                <div class="w-full lg:w-64 flex flex-col gap-5 flex-shrink-0">
                    <!-- Member/Login Box -->
                    <div class="bg-white p-4 rounded-lg shadow-md border border-gray-300" id="memberLoginBox">
                        <h3 class="text-lg font-bold text-gray-700 border-b pb-2 mb-3">Login Status</h3>
                        <div id="loadingStatus">
                            <p class="text-sm text-gray-500">Connecting to Robringer Auth...</p>
                        </div>
                        <div id="userInfo" style="display: none;">
                            <p class="text-sm">Logged in as: <strong id="loggedInUsername" class="text-blue-700"></strong></p>
                            <p class="text-xs text-gray-500 mt-1">Your ID: <span id="currentUserIdDisplay" class="font-mono"></span></p>
                            <p class="text-xs text-red-500 mt-1">Other registered users: <span id="publicUsersCount">0</span></p>
                            <button class="btn-danger text-white w-full p-2 rounded text-sm font-bold mt-3" onclick="logout()">Logout</button>
                        </div>
                    </div>

                    <!-- Get Robux Box -->
                    <div class="bg-yellow-50 p-4 rounded-lg shadow-md border border-yellow-300 text-center">
                        <h3 class="text-lg font-bold text-gray-700 mb-2">Get Robux!</h3>
                        <p class="text-sm text-gray-600 mb-3">Persists using Firestore!</p>
                        <button class="bg-gradient-to-b from-yellow-400 to-orange-500 text-gray-800 border border-yellow-700 w-full p-2 rounded text-sm font-bold shadow" onclick="addRobux(100)">Buy 100 R$</button>
                    </div>
                </div>

                <div class="w-full lg:flex-grow flex flex-col gap-5">
                    <!-- Featured Video -->
                    <div class="bg-white p-4 rounded-lg shadow-md border border-gray-300 flex flex-col md:flex-row gap-4 items-start">
                        <div class="w-full md:w-80 h-48 bg-black flex items-center justify-center text-white text-lg rounded-md flex-shrink-0">Featured Game Trailer</div>
                        <div>
                            <h2 class="text-xl font-bold text-blue-800">Welcome to Robringer!</h2>
                            <p class="text-gray-600 mb-4">Choose your own username! All data (Friends, Chat, Forums) is now real-time with Firestore.</p>
                            <button class="btn-success text-white p-3 text-lg rounded-lg font-bold" onclick="switchTab('games')">Play Now!</button>
                        </div>
                    </div>

                    <!-- Robringer News -->
                    <div class="bg-white p-4 rounded-lg shadow-md border border-gray-300">
                        <h3 class="text-lg font-bold text-gray-700 border-b pb-2 mb-3">Robringer News</h3>
                        <ul class="list-none p-0 m-0 text-sm">
                            <li class="mb-2"><a href="#" class="text-blue-600 hover:underline">New VIP Servers Feature Released!</a> - 2 hours ago</li>
                            <li class="mb-2"><a href="#" class="text-blue-600 hover:underline">The Great Spring Sale is Here!</a> - 1 day ago</li>
                            <li class="mb-2"><a href="#" class="text-blue-600 hover:underline">Avatar Editor Gets Major Update</a> - 3 days ago</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Games Tab (Simplified) -->
        <div id="gamesTab" class="tab max-w-7xl mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Games</h2>
            <div class="bg-white p-5 rounded-lg shadow-md border border-gray-300">
                <div class="flex gap-2 mb-4" id="gamesTabsContainer">
                    <button class="bg-gray-200 hover:bg-white border-b-2 border-transparent p-2 rounded-t font-bold text-sm text-gray-700 active-tab" data-category="featured" onclick="loadGames('featured', this)">Featured</button>
                    <button class="bg-gray-200 hover:bg-white border-b-2 border-transparent p-2 rounded-t font-bold text-sm text-gray-700" data-category="popular" onclick="loadGames('popular', this)">Popular</button>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4" id="gamesContent">
                    <!-- Game tiles will be inserted here by JS -->
                </div>
            </div>
        </div>

        <!-- Catalog Tab (Simplified) -->
        <div id="catalogTab" class="tab max-w-7xl mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Catalog</h2>
            <div class="bg-white p-5 rounded-lg shadow-md border border-gray-300">
                <div class="flex gap-2 mb-4" id="catalogTabsContainer">
                    <button class="bg-gray-200 hover:bg-white border-b-2 border-transparent p-2 rounded-t font-bold text-sm text-gray-700 active-tab" data-category="hats" onclick="renderCatalog('hats', this)">Hats</button>
                    <button class="bg-gray-200 hover:bg-white border-b-2 border-transparent p-2 rounded-t font-bold text-sm text-gray-700" data-category="shirts" onclick="renderCatalog('shirts', this)">Shirts</button>
                </div>
                <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-4" id="catalogContent">
                    <!-- Catalog items will be inserted here by JS -->
                </div>
            </div>
        </div>

        <!-- Friends Tab (Refactored for Firestore) -->
        <div id="friendsTab" class="tab max-w-3xl mx-auto">
            <div class="bg-white p-5 rounded-lg shadow-md border border-gray-300">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Friends</h2>
                <div class="flex gap-2 mb-4" id="friendsTabsContainer">
                    <button class="bg-gray-200 hover:bg-white border-b-2 border-transparent p-2 rounded-t font-bold text-sm text-gray-700 active-tab" data-view="myFriends" onclick="changeFriendsView('myFriends', this)">My Friends (<span id="friendCount">0</span>)</button>
                    <button class="bg-gray-200 hover:bg-white border-b-2 border-transparent p-2 rounded-t font-bold text-sm text-gray-700" data-view="requests" onclick="changeFriendsView('requests', this)">Requests (<span id="requestCount">0</span>)</button>
                    <button class="bg-gray-200 hover:bg-white border-b-2 border-transparent p-2 rounded-t font-bold text-sm text-gray-700" data-view="allUsers" onclick="changeFriendsView('allUsers', this)">All Users (<span id="allUsersCount">0</span>)</button>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <input type="text" id="friendSearchInput" placeholder="Find a user by name" class="flex-grow p-2 border rounded">
                    <button class="btn-primary text-white p-2 rounded font-bold text-sm" onclick="sendFriendRequest()">Send Request (Find by name)</button>
                </div>

                <div class="friends-list-container" id="friendsListContainer">
                    <!-- Friends and requests will be rendered here -->
                    <p id="friendsLoadingMessage" class="text-center text-gray-500">Loading friend data from Firestore...</p>
                </div>
            </div>
        </div>

        <!-- Messages Tab (Refactored for Firestore Chat) -->
        <div id="messagesTab" class="tab max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-md border border-gray-300 flex h-[600px]">
                <div class="w-1/3 border-r overflow-y-auto p-2" id="inboxSidebar">
                    <h3 class="text-lg font-bold text-gray-700 border-b pb-2 mb-2 p-1">Inbox</h3>
                    <p id="chatLoadingMessage" class="text-center text-gray-500 text-sm mt-5">Loading conversations...</p>
                    <!-- Conversation list will be rendered here by JS -->
                </div>
                <div class="w-2/3 flex flex-col">
                    <div class="p-3 border-b font-bold text-blue-700" id="chatHeader">Select a Conversation</div>
                    <div class="chat-messages flex-grow p-3 overflow-y-auto bg-gray-50" id="chatMessages">
                        <p class="text-center text-gray-500 pt-12">Select a friend to start chatting in real-time.</p>
                    </div>
                    <div class="p-3 border-t flex gap-2" id="chatInputArea" style="display: none;">
                        <input type="text" id="messageInput" placeholder="Type your message..." class="flex-grow p-2 border rounded">
                        <button class="btn-primary text-white p-2 rounded font-bold text-sm" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Tab (Refactored for Firestore) -->
        <div id="profileTab" class="tab max-w-3xl mx-auto">
            <div class="bg-white p-5 rounded-lg shadow-md border border-gray-300" id="profileContainer">
                <!-- Profile content will be inserted here by JS -->
            </div>
        </div>

        <!-- Character Tab (Canvas placeholder remains, data saved to Firestore) -->
        <div id="characterTab" class="tab max-w-3xl mx-auto">
            <div class="bg-white p-5 rounded-lg shadow-md border border-gray-300 text-center">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Character Editor</h2>
                <canvas id="avatarCanvas" width="200" height="300" class="mx-auto rounded-lg shadow-lg border-2 border-gray-400 mb-4 bg-blue-100"></canvas>
                <div class="flex justify-center gap-4 flex-wrap mb-4" id="characterTools">
                    <!-- Avatar tools/items will be inserted here -->
                </div>
                <button class="btn-primary text-white p-3 rounded-lg font-bold" onclick="saveAvatar()">Save Avatar to Firestore</button>
            </div>
        </div>

        <!-- Forum Tab (Refactored for Firestore) -->
        <div id="forumTab" class="tab max-w-5xl mx-auto">
            <div class="bg-white p-5 rounded-lg shadow-md border border-gray-300">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Robringer Forums</h2>
                <p class="text-sm text-gray-600 mb-4">All topics and posts are shared by all players via Firestore.</p>
                <div class="flex justify-between items-center mb-4">
                    <button class="btn-success text-white p-2 rounded font-bold text-sm" onclick="openNewTopicModal()">New Topic</button>
                </div>
                <div class="border border-gray-300 rounded-lg overflow-hidden" id="forumListContainer">
                    <div class="bg-gray-200 p-2 font-bold flex text-sm text-gray-700">
                        <span class="w-1/2">Topic</span>
                        <span class="w-1/4 text-center">Author</span>
                        <span class="w-1/4 text-center">Replies</span>
                    </div>
                    <div id="forumTopicsList">
                        <p class="p-4 text-center text-gray-500" id="forumLoadingMessage">Loading forum topics from Firestore...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="adminTab" class="tab max-w-3xl mx-auto">
            <div class="admin-panel-container bg-white p-5 rounded-lg shadow-md border border-gray-300">
                <h2 class="text-2xl font-bold mb-4 text-red-700">Admin Panel (ID: <span id="adminIdDisplay"></span>)</h2>
                <p class="text-sm text-gray-600 mb-4">You are the administrator and can manage all users and public data.</p>
                <div id="adminPanelContent">
                    <!-- Admin tools will be loaded here -->
                </div>
            </div>
        </div>

    </main>
    
    <!-- Custom Modal for Alerts/Confirms -->
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content">
            <h3 id="modalTitle" class="text-lg font-bold mb-3">Alert</h3>
            <p id="modalMessage" class="mb-4"></p>
            <div id="modalButtons" class="flex justify-end gap-3">
                <!-- Buttons inserted by JS -->
            </div>
        </div>
    </div>
    
    <!-- Username Setup Modal -->
    <div id="usernameModal" class="custom-modal">
        <div class="custom-modal-content">
            <h3 class="text-xl font-bold mb-4 text-blue-700">Welcome to Robringer!</h3>
            <p class="mb-3 text-gray-700">Please choose a unique username for your account. This cannot be changed later.</p>
            <input type="text" id="newUsernameInput" placeholder="Enter desired username" class="w-full p-2 border rounded mb-3">
            <button class="btn-primary text-white w-full p-2 rounded text-sm font-bold" onclick="registerUsername()">Start Playing</button>
        </div>
    </div>

    <!-- New Topic Modal -->
    <div id="newTopicModal" class="custom-modal">
        <div class="custom-modal-content max-w-xl">
            <h3 class="text-xl font-bold mb-4">Post New Topic</h3>
            <label for="topicTitle" class="block mb-1 font-semibold text-gray-700">Title:</label>
            <input type="text" id="topicTitle" class="w-full p-2 border rounded mb-3">
            <label for="topicContent" class="block mb-1 font-semibold text-gray-700">Content:</label>
            <textarea id="topicContent" rows="5" class="w-full p-2 border rounded mb-4"></textarea>
            <div class="flex justify-end gap-3">
                <button class="btn-danger text-white p-2 rounded text-sm font-bold" onclick="closeModal('newTopicModal')">Cancel</button>
                <button class="btn-success text-white p-2 rounded text-sm font-bold" onclick="submitNewTopic()">Post Topic</button>
            </div>
        </div>
    </div>
    
    <!-- Topic Detail Modal -->
    <div id="topicDetailModal" class="custom-modal">
        <div class="custom-modal-content max-w-3xl">
            <div id="topicDetailContent">
                <!-- Topic and posts will be loaded here -->
            </div>
            <div class="flex justify-end mt-4">
                 <button class="btn-primary text-white p-2 rounded font-bold text-sm" onclick="closeModal('topicDetailModal')">Close</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, arrayUnion, arrayRemove, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-robringer-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- ADMIN CONFIGURATION ---
        // The first user signing in via the initialAuthToken will be the admin for this demo.
        const ADMIN_UID = initialAuthToken ? 'ADMIN_UID_PLACEHOLDER' : 'NO_ADMIN_SET'; 

        // --- FIREBASE INITIALIZATION ---
        setLogLevel('error'); // Only log errors to keep console clean
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CORE APPLICATION STATE ---
        let currentTab = 'home';
        let currentUser = { username: 'Guest', isAdmin: false, id: null }; // id will be the Firebase UID
        let robuxBalance = 0;
        let userProfile = {};
        let friendRelationships = []; // { targetId: string, status: 'pending' | 'accepted' }
        let conversations = []; // { targetId: string, messages: array }
        let forumTopics = []; // Shared data
        let publicUsers = []; // { id: uid, username: string }
        let currentConversationId = null;

        // --- FIRESTORE PATHS ---
        function getProfileDocRef(uid) {
            return doc(db, `artifacts/${appId}/users/${uid}/profile/data`);
        }
        function getRelationshipsCollectionRef(uid) {
            return collection(db, `artifacts/${appId}/users/${uid}/relationships`);
        }
        function getConversationsCollectionRef(uid) {
            return collection(db, `artifacts/${appId}/users/${uid}/conversations`);
        }
        function getForumsCollectionRef() {
            return collection(db, `artifacts/${appId}/public/data/forums`);
        }
        function getUsersCollectionRef() {
            // Public list of all user IDs and usernames
            return collection(db, `artifacts/${appId}/public/data/users`);
        }

        // --- USER UTILITIES ---
        function getDisplayName(uid) {
            if (uid === currentUser.id) return currentUser.username;
            return publicUsers.find(u => u.id === uid)?.username || `User_${uid.substring(0, 4)}`;
        }
        function getUserIdByUsername(username) {
            return publicUsers.find(u => u.username.toLowerCase() === username.toLowerCase())?.id;
        }


        // --- UTILITY: MODALS (Fixing alert/confirm) ---
        function customAlert(title, message) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            const buttons = document.getElementById('modalButtons');
            buttons.innerHTML = `<button class="btn-primary text-white p-2 rounded text-sm font-bold" onclick="document.getElementById('customModal').style.display='none'">OK</button>`;
            modal.style.display = 'flex';
        }
        window.customAlert = customAlert; // Expose to global scope for HTML to use

        function customConfirm(title, message, callback) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            const buttons = document.getElementById('modalButtons');
            buttons.innerHTML = `
                <button class="btn-danger text-white p-2 rounded text-sm font-bold" onclick="document.getElementById('customModal').style.display='none'; window.tempCallback(false); delete window.tempCallback;">Cancel</button>
                <button class="btn-primary text-white p-2 rounded text-sm font-bold" onclick="document.getElementById('customModal').style.display='none'; window.tempCallback(true); delete window.tempCallback;">Confirm</button>
            `;
            // Attach callback to window temporarily for scope access
            window.tempCallback = callback;
            modal.style.display = 'flex';
        }
        window.customConfirm = customConfirm;

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        window.closeModal = closeModal;
        function openNewTopicModal() {
             if (!currentUser.id) { customAlert("Login Required", "Please log in to post."); return; }
             document.getElementById('newTopicModal').style.display = 'flex';
        }
        window.openNewTopicModal = openNewTopicModal;


        // --- AUTHENTICATION & INITIAL SETUP ---
        onAuthStateChanged(auth, async (user) => {
            document.getElementById('loadingStatus').textContent = 'Authenticating...';
            if (user) {
                currentUser.id = user.uid;
                
                // If initialAuthToken was used, assign the first authenticated user as Admin
                if (initialAuthToken && ADMIN_UID === 'ADMIN_UID_PLACEHOLDER') {
                    // This is a one-time assignment in the local runtime
                    window.ADMIN_UID = user.uid;
                }
                
                currentUser.isAdmin = user.uid === window.ADMIN_UID; 

                // 1. Start Public Listeners
                startUserListListener();
                startForumListener();
                
                // 2. Check for existing profile
                const profileDoc = await getDoc(getProfileDocRef(user.uid));

                if (profileDoc.exists()) {
                    // Existing User: Load profile and start user-specific listeners
                    const data = profileDoc.data();
                    currentUser.username = data.username;
                    
                    startProfileListener(currentUser.id);
                    startFriendListener(currentUser.id);
                    startConversationsListener(currentUser.id);
                    
                    document.getElementById('loadingStatus').style.display = 'none';
                } else {
                    // New User: Prompt for username
                    document.getElementById('loadingStatus').textContent = 'New User. Setting up profile...';
                    document.getElementById('usernameModal').style.display = 'flex';
                }

            } else {
                // Not authenticated or logged out
                currentUser = { username: 'Guest', isAdmin: false, id: null };
                // Clear state
                friendRelationships = [];
                conversations = [];
                robuxBalance = 0;
                document.getElementById('loadingStatus').textContent = 'Signed out.';
                document.getElementById('loadingStatus').style.display = 'block';
            }
            
            updateUIBasedOnLogin();
        });
        
        async function signIn() {
            // This function is for initial authentication/token check only. 
            // The onAuthStateChanged handles the flow.
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                // Success handled by onAuthStateChanged
            } catch (error) {
                console.error("Firebase Sign-In Error:", error);
                document.getElementById('loadingStatus').textContent = 'Connection Failed. See console.';
            }
        }

        async function registerUsername() {
            const newUsername = document.getElementById('newUsernameInput').value.trim();
            if (newUsername.length < 3) {
                customAlert('Error', 'Username must be at least 3 characters long.');
                return;
            }
            
            // Check if username is already taken
            const isTaken = publicUsers.some(u => u.username.toLowerCase() === newUsername.toLowerCase());
            if (isTaken) {
                customAlert('Error', `The username "${newUsername}" is already taken.`);
                return;
            }

            // Create default profile
            userProfile = { username: newUsername, robux: 100, avatarItems: [101, 201] };
            
            try {
                // 1. Create Profile Document
                await setDoc(getProfileDocRef(currentUser.id), userProfile);
                
                // 2. Add to Public User List
                await setDoc(doc(getUsersCollectionRef(), currentUser.id), {
                    id: currentUser.id,
                    username: newUsername
                });
                
                currentUser.username = newUsername;
                document.getElementById('usernameModal').style.display = 'none';
                
                // Start user-specific listeners
                startProfileListener(currentUser.id);
                startFriendListener(currentUser.id);
                startConversationsListener(currentUser.id);

                updateUIBasedOnLogin();
                customAlert('Welcome!', `Your username "${newUsername}" has been registered!`);

            } catch (e) {
                console.error("Error registering username:", e);
                customAlert('Error', 'Failed to register username. Please try again.');
            }
        }
        window.registerUsername = registerUsername;
        
        function logout() {
            // For a real app, this would sign out the user, but since we use anonymous auth, 
            // we let the user stay signed in but update the UI state. 
            auth.signOut();
            updateUIBasedOnLogin();
            customAlert('Logged Out', 'You have been signed out. Refresh the page to sign in anonymously again.');
        }
        window.logout = logout;

        function updateUIBasedOnLogin() {
            const isAuthenticated = !!currentUser.id && currentUser.username !== 'Guest';
            
            if (isAuthenticated) {
                document.getElementById('loadingStatus').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('loggedInUsername').textContent = currentUser.username;
                document.getElementById('currentUserIdDisplay').textContent = currentUser.id;
                document.getElementById('currentUserSpan').textContent = currentUser.username;
                document.getElementById('adminLink').style.display = currentUser.isAdmin ? 'block' : 'none';
                document.getElementById('adminIdDisplay').textContent = currentUser.id;
                document.getElementById('publicUsersCount').textContent = publicUsers.length;
            } else {
                document.getElementById('loadingStatus').style.display = 'block';
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('currentUserSpan').textContent = 'Guest';
                document.getElementById('adminLink').style.display = 'none';
                document.getElementById('publicUsersCount').textContent = publicUsers.length;
            }
            
            // Re-render user-specific views
            if (currentTab === 'profile') renderProfile();
            if (currentTab === 'friends') renderFriends();
            if (currentTab === 'messages') renderChatMessages();
            if (currentTab === 'admin' && currentUser.isAdmin) loadAdminPanel();
            if (currentTab === 'character') initCharacterEditor();
        }


        // --- FIRESTORE LISTENERS (Real-Time Data) ---

        // 0. Public User List Listener (Needed for lookup)
        function startUserListListener() {
            onSnapshot(getUsersCollectionRef(), (snapshot) => {
                publicUsers = snapshot.docs.map(doc => doc.data());
                updateUIBasedOnLogin(); // Update the user count
                if (currentTab === 'friends') renderFriends(); // Friends relies on this
                if (currentTab === 'admin' && currentUser.isAdmin) loadAdminPanel();
            }, (error) => console.error("User List Listener Error:", error));
        }

        // 1. Profile Listener (Robux, Avatar Items)
        function startProfileListener(uid) {
            onSnapshot(getProfileDocRef(uid), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    userProfile = docSnapshot.data();
                } else {
                    // Profile deleted (shouldn't happen for signed-in user)
                    userProfile = { robux: 0, avatarItems: [] };
                }
                robuxBalance = userProfile.robux || 0;
                document.getElementById('robuxBalance').textContent = robuxBalance.toLocaleString();
                if (currentTab === 'profile') renderProfile();
                if (currentTab === 'character') initCharacterEditor();
            }, (error) => console.error("Profile Listener Error:", error));
        }

        // 2. Friends Listener (Relationships)
        function startFriendListener(uid) {
            const q = query(getRelationshipsCollectionRef(uid));
            onSnapshot(q, (snapshot) => {
                friendRelationships = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentTab === 'friends') renderFriends();
                document.getElementById('friendCount').textContent = friendRelationships.filter(f => f.status === 'accepted').length;
                document.getElementById('requestCount').textContent = friendRelationships.filter(f => f.status === 'request').length;
            }, (error) => console.error("Friends Listener Error:", error));
        }

        // 3. Conversations Listener (Chat)
        function startConversationsListener(uid) {
            const q = query(getConversationsCollectionRef(uid));
            onSnapshot(q, (snapshot) => {
                conversations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // If a conversation is currently open, refresh the messages
                if (currentConversationId) {
                    const activeConvo = conversations.find(c => c.id === currentConversationId);
                    if (activeConvo) displayConversation(activeConvo);
                }
                if (currentTab === 'messages') renderChatMessages();
            }, (error) => console.error("Conversations Listener Error:", error));
        }

        // 4. Forum Listener (Public Topics)
        function startForumListener() {
            const q = query(getForumsCollectionRef());
            onSnapshot(q, (snapshot) => {
                forumTopics = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                if (currentTab === 'forum') renderForum();
            }, (error) => console.error("Forum Listener Error:", error));
        }
        

        // --- ROBux & AVATAR LOGIC (Firestore Updates) ---

        async function saveProfileData() {
            if (!currentUser.id) return;
            try {
                await setDoc(getProfileDocRef(currentUser.id), userProfile, { merge: true });
            } catch (e) {
                console.error("Error saving profile:", e);
                customAlert('Error', 'Failed to save profile data.');
            }
        }
        
        async function addRobux(amount) {
            if (!currentUser.id || currentUser.username === 'Guest') {
                customAlert("Login Required", "You must be logged in to buy Robux.");
                return;
            }
            userProfile.robux = (userProfile.robux || 0) + amount;
            await saveProfileData();
            customAlert('Success', `Added ${amount} R$ to your account!`);
        }
        window.addRobux = addRobux;

        async function saveAvatar() {
             if (!currentUser.id || currentUser.username === 'Guest') {
                customAlert("Login Required", "You must be logged in to save your avatar.");
                return;
            }
            await saveProfileData();
            customAlert('Success', 'Avatar changes saved to Firestore.');
        }
        window.saveAvatar = saveAvatar;

        async function buyItem(itemId, category) {
            if (!currentUser.id || currentUser.username === 'Guest') {
                customAlert("Login Required", "You must be logged in to purchase items.");
                return;
            }
            const item = catalogItems[category].find(i => i.id === itemId);
            if (!item || userProfile.avatarItems.includes(item.id)) return;

            if (userProfile.robux >= item.price) {
                userProfile.robux -= item.price;
                // Use arrayUnion for robust updates
                userProfile.avatarItems = arrayUnion(item.id); 
                await saveProfileData();
                customAlert('Success', `Purchased ${item.name}! New balance: ${userProfile.robux} R$`);
                renderCatalog(category);
            } else {
                customAlert('Error', `Not enough Robux to buy ${item.name}. (Need ${item.price - userProfile.robux} more)`);
            }
        }
        window.buyItem = buyItem;
        
        // --- FRIEND SYSTEM LOGIC (Firestore) ---
        async function sendFriendRequest() {
            if (!currentUser.id || currentUser.username === 'Guest') { customAlert("Login Required", "Please log in first."); return; }
            
            const username = document.getElementById('friendSearchInput').value.trim();
            if (!username) { customAlert('Error', 'Please enter a username.'); return; }
            
            const targetId = getUserIdByUsername(username);
            
            if (!targetId) {
                customAlert('Error', `User "${username}" not found or does not exist.`);
                return;
            }
            if (targetId === currentUser.id) {
                customAlert('Error', `You cannot friend yourself.`);
                return;
            }

            // Check if already friends or requested (use current state from listener)
            if (friendRelationships.some(r => r.targetId === targetId && (r.status === 'accepted' || r.status === 'pending'))) {
                customAlert('Status', 'Friendship or pending request already exists.');
                return;
            }
            
            try {
                // 1. Add request to *sender's* relationships (status: pending)
                await setDoc(doc(getRelationshipsCollectionRef(currentUser.id), targetId), {
                    targetId: targetId,
                    status: 'pending' 
                });
                // 2. Add request to *recipient's* relationships (status: request)
                await setDoc(doc(getRelationshipsCollectionRef(targetId), currentUser.id), {
                    targetId: currentUser.id,
                    status: 'request' // Use 'request' to differentiate from pending sent
                });
                customAlert('Success', `Friend request sent to ${username}!`);
                document.getElementById('friendSearchInput').value = '';
            } catch (e) {
                console.error("Error sending friend request:", e);
                customAlert('Error', 'Failed to send friend request.');
            }
        }
        window.sendFriendRequest = sendFriendRequest;

        async function acceptFriendRequest(senderId) {
            if (!currentUser.id || currentUser.username === 'Guest') return;
            try {
                // 1. Update *current user's* relationship (request -> accepted)
                await updateDoc(doc(getRelationshipsCollectionRef(currentUser.id), senderId), { status: 'accepted' });
                // 2. Update *sender's* relationship (pending -> accepted)
                await updateDoc(doc(getRelationshipsCollectionRef(senderId), currentUser.id), { status: 'accepted' });
                customAlert('Success', `You are now friends with ${getDisplayName(senderId)}!`);
            } catch (e) {
                console.error("Error accepting request:", e);
                customAlert('Error', 'Failed to accept friend request.');
            }
        }
        window.acceptFriendRequest = acceptFriendRequest;

        async function declineFriendRequest(senderId) {
            if (!currentUser.id || currentUser.username === 'Guest') return;
            customConfirm('Remove/Decline', `Are you sure you want to remove the relationship with ${getDisplayName(senderId)}?`, async (confirmed) => {
                if (confirmed) {
                    try {
                        // 1. Delete relationship from *current user*
                        await deleteDoc(doc(getRelationshipsCollectionRef(currentUser.id), senderId));
                        // 2. Delete relationship from *other user*
                        await deleteDoc(doc(getRelationshipsCollectionRef(senderId), currentUser.id));
                        customAlert('Success', `Relationship with ${getDisplayName(senderId)} removed.`);
                    } catch (e) {
                        console.error("Error declining/removing friend:", e);
                        customAlert('Error', 'Failed to remove relationship.');
                    }
                }
            });
        }
        window.declineFriendRequest = declineFriendRequest;
        
        function changeFriendsView(view, button) {
            document.querySelectorAll('#friendsTabsContainer button').forEach(btn => btn.classList.remove('active-tab'));
            if (button) button.classList.add('active-tab');
            renderFriends(view);
        }
        window.changeFriendsView = changeFriendsView;


        // --- CHAT SYSTEM LOGIC (Firestore) ---
        function openConversation(targetId) {
            if (!currentUser.id || currentUser.username === 'Guest') { customAlert("Login Required", "Please log in to chat."); return; }
            currentConversationId = targetId;
            const convo = conversations.find(c => c.id === targetId);
            
            // Ensure both sides have a conversation document initialized for arrayUnion to work on existing field.
            const initMessages = { messages: [] };
            setDoc(doc(getConversationsCollectionRef(currentUser.id), targetId), initMessages, { merge: true });
            setDoc(doc(getConversationsCollectionRef(targetId), currentUser.id), initMessages, { merge: true });

            document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.conversation-item[data-target-id="${targetId}"]`)?.classList.add('active');
            
            document.getElementById('chatHeader').textContent = `Chatting with ${getDisplayName(targetId)}`;
            document.getElementById('chatInputArea').style.display = 'flex';
            
            // Manually display the conversation data if already loaded
            if (convo) displayConversation(convo);
            else document.getElementById('chatMessages').innerHTML = '<p class="text-center text-gray-500 pt-12">No messages yet. Start the conversation!</p>';
        }
        window.openConversation = openConversation;

        function displayConversation(convo) {
            const chatMessagesEl = document.getElementById('chatMessages');
            chatMessagesEl.innerHTML = '';

            if (convo.messages && Array.isArray(convo.messages)) {
                convo.messages.forEach(msg => {
                    const bubble = document.createElement('div');
                    const isSent = msg.senderId === currentUser.id;
                    
                    bubble.className = `message-bubble max-w-sm p-3 rounded-xl shadow-md mb-2 ${isSent ? 'bg-blue-600 text-white ml-auto rounded-br-sm' : 'bg-gray-200 text-gray-800 mr-auto rounded-bl-sm'}`;
                    
                    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    bubble.innerHTML = `
                        <p class="mb-1">${msg.content}</p>
                        <span class="text-xs ${isSent ? 'text-white/70' : 'text-gray-500'} block text-right">${time}</span>
                    `;
                    chatMessagesEl.appendChild(bubble);
                });
            } else {
                 chatMessagesEl.innerHTML = '<p class="text-center text-gray-500 pt-12">No messages yet. Start the conversation!</p>';
            }
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        async function sendMessage() {
            if (!currentUser.id || currentUser.username === 'Guest' || !currentConversationId) return;
            
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;

            const targetId = currentConversationId;
            const message = {
                senderId: currentUser.id,
                content: content,
                timestamp: Date.now()
            };

            try {
                // 1. Add message to current user's conversation document
                await updateDoc(doc(getConversationsCollectionRef(currentUser.id), targetId), {
                    messages: arrayUnion(message)
                });

                // 2. Add message to recipient's conversation document
                 await updateDoc(doc(getConversationsCollectionRef(targetId), currentUser.id), {
                     messages: arrayUnion(message)
                 });
                
                input.value = '';
                // The 'onSnapshot' listener handles the display refresh automatically
            } catch (e) {
                console.error("Error sending message:", e);
                customAlert('Error', 'Failed to send message.');
            }
        }
        window.sendMessage = sendMessage;


        // --- FORUM SYSTEM LOGIC (Firestore) ---
        async function submitNewTopic() {
            if (!currentUser.id || currentUser.username === 'Guest') { customAlert("Login Required", "Please log in to post."); return; }
            
            const title = document.getElementById('topicTitle').value.trim();
            const content = document.getElementById('topicContent').value.trim();

            if (!title || !content) { customAlert('Error', 'Title and content cannot be empty.'); return; }
            
            try {
                await addDoc(getForumsCollectionRef(), {
                    title: title,
                    content: content,
                    authorId: currentUser.id,
                    timestamp: Date.now(),
                    replies: []
                });
                
                document.getElementById('topicTitle').value = '';
                document.getElementById('topicContent').value = '';
                closeModal('newTopicModal');
                customAlert('Success', 'New topic posted successfully!');
            } catch (e) {
                console.error("Error posting topic:", e);
                customAlert('Error', 'Failed to post topic.');
            }
        }
        window.submitNewTopic = submitNewTopic;
        
        async function deleteTopic(topicId) {
            if (!currentUser.isAdmin) return;
            
            const topic = forumTopics.find(t => t.id === topicId);
            if (!topic) return;

            customConfirm('Delete Topic', `Are you sure you want to delete topic "${topic.title}"? This cannot be undone.`, async (confirmed) => {
                if (confirmed) {
                    try {
                        await deleteDoc(doc(getForumsCollectionRef(), topicId));
                        customAlert('Success', `Topic "${topic.title}" deleted.`);
                    } catch (e) {
                        console.error("Error deleting topic:", e);
                        customAlert('Error', 'Failed to delete topic.');
                    }
                }
            });
        }
        window.deleteTopic = deleteTopic;
        
        async function submitReply(topicId) {
            const replyInput = document.getElementById('replyInput');
            const replyContent = replyInput.value.trim();
            if (!currentUser.id || currentUser.username === 'Guest') { customAlert("Login Required", "Please log in to reply."); return; }
            if (!replyContent) { return; }

            const reply = {
                authorId: currentUser.id,
                content: replyContent,
                timestamp: Date.now()
            };

            try {
                await updateDoc(doc(getForumsCollectionRef(), topicId), {
                    replies: arrayUnion(reply)
                });
                replyInput.value = '';
                customAlert('Success', 'Reply posted!');
                // Re-render topic details (the onSnapshot will update the list, but we need to re-render the modal)
                // Fetch the latest version of the topic from the forumTopics array
                const updatedTopic = forumTopics.find(t => t.id === topicId);
                if (updatedTopic) renderTopicDetail(updatedTopic);
            } catch (e) {
                console.error("Error posting reply:", e);
                customAlert('Error', 'Failed to post reply.');
            }
        }
        window.submitReply = submitReply;


        // --- RENDERING FUNCTIONS ---
        
        function renderFriends(view = 'myFriends') {
            if (!currentUser.id || currentUser.username === 'Guest') {
                document.getElementById('friendsListContainer').innerHTML = '<p class="text-center text-red-500 mt-5">Please log in to manage friends.</p>';
                return;
            }
            
            const container = document.getElementById('friendsListContainer');
            container.innerHTML = '';
            document.getElementById('friendsLoadingMessage').style.display = 'none';

            let list = [];
            
            if (view === 'myFriends') {
                list = friendRelationships.filter(f => f.status === 'accepted').map(r => ({ id: r.targetId }));
            } else if (view === 'requests') {
                list = friendRelationships.filter(f => f.status === 'request').map(r => ({ id: r.targetId, status: 'request' })); 
            } else if (view === 'allUsers') {
                 // Show all registered users except self
                const currentRelationships = new Set(friendRelationships.map(r => r.targetId));
                list = publicUsers
                    .filter(u => u.id !== currentUser.id)
                    .map(u => {
                        const rel = friendRelationships.find(r => r.targetId === u.id);
                        return { 
                            id: u.id, 
                            status: rel ? rel.status : 'none' // 'none' means not friends/pending/request
                        };
                    });
            }

            document.getElementById('allUsersCount').textContent = publicUsers.length > 0 ? publicUsers.length - 1 : 0;

            if (list.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 mt-5">No ${view.replace(/([A-Z])/g, ' $1').toLowerCase().replace('all users', 'users')} found.</p>`;
                return;
            }

            list.forEach(rel => {
                const targetId = rel.id;
                const targetUser = getDisplayName(targetId);
                const currentStatus = rel.status;
                
                const tile = document.createElement('div');
                tile.className = 'flex items-center justify-between p-3 border-b hover:bg-gray-50';
                
                let actions = '';
                if (currentStatus === 'request') {
                    actions = `
                        <button class="btn-success text-white px-3 py-1 rounded text-xs font-bold" onclick="acceptFriendRequest('${targetId}')">Accept</button>
                        <button class="btn-danger text-white px-3 py-1 rounded text-xs font-bold" onclick="declineFriendRequest('${targetId}')">Decline</button>
                    `;
                } else if (currentStatus === 'accepted') {
                     actions = `
                         <button class="btn-primary text-white px-3 py-1 rounded text-xs font-bold mr-2" onclick="switchTab('messages'); openConversation('${targetId}')">Message</button>
                         <button class="btn-danger text-white px-3 py-1 rounded text-xs font-bold" onclick="declineFriendRequest('${targetId}')">Remove</button>
                     `;
                } else if (currentStatus === 'pending') {
                    actions = '<span class="text-sm text-gray-500 italic">Pending...</span>';
                } else if (currentStatus === 'none' && view === 'allUsers') {
                    actions = `<button class="btn-primary text-white px-3 py-1 rounded text-xs font-bold" onclick="document.getElementById('friendSearchInput').value='${targetUser}'; sendFriendRequest()">Add Friend</button>`;
                }

                tile.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-lg">${targetUser.charAt(0)}</div>
                        <span class="font-semibold text-blue-700">${targetUser}</span>
                    </div>
                    <div>${actions}</div>
                `;
                container.appendChild(tile);
            });
        }
        window.renderFriends = renderFriends;

        function renderChatMessages() {
            if (!currentUser.id || currentUser.username === 'Guest') {
                document.getElementById('inboxSidebar').innerHTML = '<p class="text-center text-red-500 p-5">Please log in to use chat.</p>';
                document.getElementById('chatMessages').innerHTML = '<p class="text-center text-gray-500 pt-12">Login to chat with your friends.</p>';
                document.getElementById('chatInputArea').style.display = 'none';
                document.getElementById('chatLoadingMessage').style.display = 'none';
                return;
            }
            
            document.getElementById('chatLoadingMessage').style.display = 'none';
            const sidebar = document.getElementById('inboxSidebar');
            const convoList = document.createElement('div');
            convoList.id = 'convoList';
            sidebar.innerHTML = '';
            sidebar.appendChild(document.createElement('h3')).className = 'text-lg font-bold text-gray-700 border-b pb-2 mb-2 p-1';
            sidebar.lastChild.textContent = 'Inbox';
            sidebar.appendChild(convoList);

            // Only show conversations with accepted friends
            const friends = friendRelationships.filter(f => f.status === 'accepted');
            
            if (friends.length === 0) {
                 convoList.innerHTML = '<p class="p-3 text-sm text-gray-500">Add friends to start chatting!</p>';
                 return;
            }

            friends.forEach(friend => {
                const targetId = friend.targetId;
                const targetUser = getDisplayName(targetId);
                const convo = conversations.find(c => c.id === targetId);
                const lastMessage = convo?.messages?.[convo.messages.length - 1];

                const item = document.createElement('div');
                item.className = 'conversation-item flex items-center p-3 gap-3 cursor-pointer border-b hover:bg-gray-100 transition-colors';
                if (currentConversationId === targetId) item.classList.add('active');
                item.setAttribute('data-target-id', targetId);
                item.onclick = () => openConversation(targetId);

                item.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-blue-800 font-bold flex-shrink-0">${targetUser.charAt(0)}</div>
                    <div class="flex-grow overflow-hidden">
                        <h4 class="text-sm font-bold text-gray-800">${targetUser}</h4>
                        <p class="text-xs text-gray-500 truncate">${lastMessage ? (lastMessage.senderId === currentUser.id ? 'You: ' : '') + lastMessage.content : 'No messages yet.'}</p>
                    </div>
                `;
                convoList.appendChild(item);
            });

            if (currentConversationId) {
                const activeConvo = conversations.find(c => c.id === currentConversationId);
                if (activeConvo) displayConversation(activeConvo);
                else {
                    document.getElementById('chatHeader').textContent = `Chatting with ${getDisplayName(currentConversationId)}`;
                    document.getElementById('chatMessages').innerHTML = '<p class="text-center text-gray-500 pt-12">No messages yet. Start the conversation!</p>';
                    document.getElementById('chatInputArea').style.display = 'flex';
                }
            } else {
                 document.getElementById('chatHeader').textContent = 'Select a Conversation';
                 document.getElementById('chatMessages').innerHTML = '<p class="text-center text-gray-500 pt-12">Select a friend to start chatting in real-time.</p>';
                 document.getElementById('chatInputArea').style.display = 'none';
            }
        }
        window.renderChatMessages = renderChatMessages;

        function renderForum() {
            const container = document.getElementById('forumTopicsList');
            container.innerHTML = '';
            document.getElementById('forumLoadingMessage').style.display = 'none';

            if (forumTopics.length === 0) {
                 container.innerHTML = '<p class="p-4 text-center text-gray-500">No topics found. Be the first to post!</p>';
                 return;
            }

            forumTopics.forEach(topic => {
                const row = document.createElement('div');
                row.className = 'p-3 flex text-sm border-b hover:bg-gray-100 cursor-pointer items-center';
                row.onclick = () => renderTopicDetail(topic);

                const replies = topic.replies ? topic.replies.length : 0;
                const authorName = getDisplayName(topic.authorId);

                row.innerHTML = `
                    <div class="w-1/2 font-semibold text-blue-700">${topic.title}</div>
                    <div class="w-1/4 text-center text-gray-600">${authorName}</div>
                    <div class="w-1/4 text-center text-gray-600">${replies}</div>
                    ${currentUser.isAdmin ? `<button class="btn-danger p-1 rounded text-xs ml-2" onclick="event.stopPropagation(); deleteTopic('${topic.id}')">Delete</button>` : ''}
                `;
                container.appendChild(row);
            });
        }
        window.renderForum = renderForum;
        
        function renderTopicDetail(topic) {
            const content = document.getElementById('topicDetailContent');
            const replies = topic.replies || [];
            
            // Render the topic and replies
            let repliesHtml = replies.map(reply => `
                <div class="bg-gray-100 p-3 rounded-lg mt-3 shadow-sm border border-gray-200">
                    <p class="text-xs text-gray-500 font-bold">${getDisplayName(reply.authorId)} <span class="font-normal text-gray-400 ml-2">${new Date(reply.timestamp).toLocaleString()}</span></p>
                    <p class="text-sm mt-1">${reply.content}</p>
                </div>
            `).join('');

            content.innerHTML = `
                <h3 class="text-2xl font-bold mb-2 text-blue-800">${topic.title}</h3>
                <p class="text-sm text-gray-500 mb-4">Posted by <span class="font-semibold">${getDisplayName(topic.authorId)}</span> on ${new Date(topic.timestamp).toLocaleString()} | Replies: ${replies.length}</p>
                <div class="bg-white p-4 border rounded-lg shadow-inner mb-6">
                    <p class="text-base">${topic.content}</p>
                </div>
                
                <h4 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">Replies</h4>
                <div class="mb-6 max-h-96 overflow-y-auto">${repliesHtml}</div>
                
                <div class="mt-4 border-t pt-4">
                    <h5 class="font-bold mb-2 text-gray-700">Post a Reply</h5>
                    <textarea id="replyInput" rows="3" class="w-full p-2 border rounded mb-2" placeholder="Your reply..."></textarea>
                    <div class="flex justify-end">
                        <button class="btn-primary text-white p-2 rounded font-bold text-sm" onclick="submitReply('${topic.id}')">Post Reply</button>
                    </div>
                </div>
            `;
            document.getElementById('topicDetailModal').style.display = 'flex';
        }
        window.renderTopicDetail = renderTopicDetail;

        // --- DUMMY/SETUP RENDERING FUNCTIONS (Kept from previous version) ---
        
        const gamesData = [
            { id: 1, name: 'Bloxy Battlegrounds', players: 9876, category: 'featured', description: 'The ultimate FPS shooter.' },
            { id: 2, name: 'Obby Mania', players: 5123, category: 'popular', description: 'Jump, climb, and conquer the impossible.' },
            { id: 3, name: 'Welcome to Robringer', players: 3200, category: 'featured', description: 'The official starting experience.' },
            { id: 4, name: 'Island Tycoon', players: 880, category: 'popular', description: 'Build your own island empire.' },
        ];

        const catalogItems = {
            hats: [
                { id: 101, name: 'Top Hat', price: 100, color: 'black' },
                { id: 102, name: 'Builder Helmet', price: 50, color: 'yellow' },
                { id: 103, name: 'Fedora', price: 250, color: 'gray' },
            ],
            shirts: [
                { id: 201, name: 'Blue T-Shirt', price: 25, color: 'blue' },
                { id: 202, name: 'Red Hoodie', price: 75, color: 'red' },
            ],
        };

        function loadGames(category = 'featured', button = null) {
            const container = document.getElementById('gamesContent');
            document.querySelectorAll('#gamesTabsContainer button').forEach(btn => btn.classList.remove('active-tab'));
            if (button) button.classList.add('active-tab');

            const filteredGames = gamesData.filter(game => game.category === category);
            container.innerHTML = '';

            filteredGames.forEach(game => {
                const tile = document.createElement('div');
                tile.className = 'bg-white border border-gray-300 p-3 rounded-lg shadow-sm text-center transition hover:shadow-lg';
                tile.innerHTML = `
                    <div class="h-24 bg-gray-200 flex items-center justify-center rounded-md mb-2">
                        <img src="https://placehold.co/100x70/c3c3c3/333?text=${game.name.replace(/\s/g, '+')}" alt="${game.name}" class="rounded-sm">
                    </div>
                    <strong class="block text-sm font-bold text-gray-800">${game.name}</strong>
                    <p class="text-xs text-gray-500 mb-2">${game.players.toLocaleString()} Playing</p>
                    <button class="btn-primary text-white w-full p-1 rounded text-xs font-bold" onclick="customAlert('Game Launch', 'Launching ${game.name}... (Game logic not implemented in this demo)')">Play</button>
                `;
                container.appendChild(tile);
            });
        }
        window.loadGames = loadGames;


        function renderCatalog(category = 'hats', button = null) {
            if (!userProfile.avatarItems) return;
            const container = document.getElementById('catalogContent');
            document.querySelectorAll('#catalogTabsContainer button').forEach(btn => btn.classList.remove('active-tab'));
            if (button) button.classList.add('active-tab');

            const items = catalogItems[category];
            container.innerHTML = '';

            items.forEach(item => {
                const isOwned = userProfile.avatarItems.includes(item.id);
                const tile = document.createElement('div');
                tile.className = 'bg-white border border-gray-300 p-3 rounded-lg shadow-sm text-center transition hover:shadow-lg';
                tile.innerHTML = `
                    <div class="h-20 bg-gray-100 flex items-center justify-center rounded-md mb-2 text-3xl font-black text-${item.color}-600">${item.name.charAt(0)}</div>
                    <strong class="block text-sm font-bold text-gray-800">${item.name}</strong>
                    <p class="text-xs text-blue-600 mb-2">R$${item.price}</p>
                    <button class="w-full p-1 rounded text-xs font-bold ${isOwned ? 'bg-gray-500 text-white' : 'btn-primary text-white'}" ${isOwned ? 'disabled' : ''} onclick="buyItem(${item.id}, '${category}')">
                        ${isOwned ? 'Owned' : 'Buy'}
                    </button>
                `;
                container.appendChild(tile);
            });
        }
        window.renderCatalog = renderCatalog;


        function renderProfile() {
            const container = document.getElementById('profileContainer');
            if (!currentUser.id || currentUser.username === 'Guest') {
                container.innerHTML = '<p class="text-center text-red-500 mt-5">Please log in to view your profile.</p>';
                return;
            }
            
            const ownedItems = catalogItems.hats.filter(h => userProfile.avatarItems?.includes(h.id))
                                .concat(catalogItems.shirts.filter(s => userProfile.avatarItems?.includes(s.id)));

            container.innerHTML = `
                <div class="flex items-center gap-6 border-b pb-4 mb-4">
                    <div class="w-24 h-24 bg-blue-400 rounded-full flex items-center justify-center text-white text-3xl font-bold flex-shrink-0 border-4 border-blue-600">${currentUser.username.charAt(0)}</div>
                    <div>
                        <h2 class="text-3xl font-extrabold text-blue-700">${currentUser.username}</h2>
                        <p class="text-lg text-gray-600">ID: ${currentUser.id}</p>
                        <p class="text-xl font-bold text-orange-600 mt-2">Robux: R$${robuxBalance.toLocaleString()}</p>
                    </div>
                </div>

                <h3 class="text-xl font-bold mb-3 text-gray-700">Inventory (${ownedItems.length} Items)</h3>
                <div class="flex flex-wrap gap-4">
                    ${ownedItems.map(item => `
                        <div class="w-24 p-2 border rounded-lg text-center shadow-sm">
                            <div class="h-10 bg-gray-100 flex items-center justify-center rounded-md mb-1 text-2xl font-black text-${item.color}-600">${item.name.charAt(0)}</div>
                            <p class="text-xs font-semibold">${item.name}</p>
                        </div>
                    `).join('')}
                    ${ownedItems.length === 0 ? '<p class="text-gray-500">Go to the Catalog to buy items!</p>' : ''}
                </div>
            `;
        }
        window.renderProfile = renderProfile;

        function initCharacterEditor() {
            const canvas = document.getElementById('avatarCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const toolsContainer = document.getElementById('characterTools');
            toolsContainer.innerHTML = '';
            
            if (!userProfile.avatarItems) return;

            // Draw initial placeholder avatar
            ctx.fillStyle = '#FFD700'; // Head
            ctx.fillRect(75, 40, 50, 50);
            ctx.fillStyle = '#0077CC'; // Torso
            ctx.fillRect(65, 90, 70, 100);

            // Render owned items
            const allItems = catalogItems.hats.concat(catalogItems.shirts);
            allItems.forEach(item => {
                const isOwned = userProfile.avatarItems?.includes(item.id);
                const container = document.createElement('div');
                container.className = `p-3 rounded-lg text-center cursor-pointer transition w-24 border ${isOwned ? 'bg-blue-500 text-white shadow-lg' : 'bg-gray-100 text-gray-700'}`;
                
                container.innerHTML = `
                    <div class="h-10 bg-white flex items-center justify-center rounded-md mb-1 text-2xl font-black text-${item.color}-600">${item.name.charAt(0)}</div>
                    <p class="text-xs font-semibold mt-1">${item.name}</p>
                `;
                
                // Simplified character rendering: drawing a colored box/circle on the canvas
                container.onclick = () => {
                    if (isOwned) {
                        // Redraw base avatar
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#FFD700'; // Head
                        ctx.fillRect(75, 40, 50, 50);
                        ctx.fillStyle = '#0077CC'; // Torso
                        ctx.fillRect(65, 90, 70, 100);
                        
                        ctx.beginPath();
                        if (item.name.includes('Hat')) { // Draw a simple hat
                            ctx.fillStyle = item.color;
                            ctx.fillRect(50, 50, 100, 30);
                        } else { // Draw a simple shirt overlay
                            ctx.fillStyle = item.color;
                            ctx.fillRect(65, 90, 70, 100); // Redraw torso with item color
                        }
                        ctx.fill();
                        customAlert('Equipped', `Equipped ${item.name}! Click 'Save Avatar' to save this choice to Firestore.`);
                    } else {
                        customAlert('Not Owned', `You must buy the ${item.name} in the Catalog first.`);
                    }
                };
                toolsContainer.appendChild(container);
            });
        }
        window.initCharacterEditor = initCharacterEditor;

        function loadAdminPanel() {
            if (!currentUser.isAdmin) return;
            const content = document.getElementById('adminPanelContent');
            
            // Simple display of all registered users for admin purposes
            const userList = publicUsers.map(u => `
                <li class="p-2 border-b flex justify-between items-center">
                    <span class="font-bold text-blue-700">${u.username}</span>
                    <span class="font-mono text-xs text-gray-700">${u.id}</span>
                </li>
            `).join('');

            content.innerHTML = `
                <h3 class="text-lg font-bold mb-3">Managed Users (${publicUsers.length})</h3>
                <ul class="border rounded-lg mb-6 bg-gray-50 max-h-60 overflow-y-auto">${userList}</ul>
                
                <h3 class="text-lg font-bold mb-3">Topic Management</h3>
                <p class="text-sm text-gray-600 mb-2">Total Topics: ${forumTopics.length}</p>
                <div class="border rounded-lg max-h-60 overflow-y-auto">
                    ${forumTopics.map(topic => `
                        <div class="p-2 border-b flex justify-between items-center text-sm">
                            <span class="truncate w-4/5">${topic.title}</span>
                            <button class="btn-danger p-1 rounded text-xs ml-2 flex-shrink-0" onclick="deleteTopic('${topic.id}')">Delete</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        window.loadAdminPanel = loadAdminPanel;
        
        // --- TAB NAVIGATION ---
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = link.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            if (tabName === 'admin' && !currentUser.isAdmin) return; 
            if (tabName !== 'home' && currentUser.username === 'Guest') {
                 customAlert('Login Required', 'You must choose a username to access this page.');
                 return;
            }

            currentTab = tabName;
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active-link'));

            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active-link');

            // Specific tab loading logic
            if (tabName === 'games') loadGames();
            if (tabName === 'character') initCharacterEditor();
            if (tabName === 'profile') renderProfile();
            if (tabName === 'catalog') renderCatalog();
            if (tabName === 'friends') renderFriends();
            if (tabName === 'messages') renderChatMessages();
            if (tabName === 'forum') renderForum();
            if (tabName === 'admin') loadAdminPanel();
        }
        window.switchTab = switchTab;
        
        // --- Initial Load Functions ---
        document.addEventListener('DOMContentLoaded', () => {
            // Start the sign-in process
            signIn(); 
            // Load default/public data initially
            loadGames(); 
        });
    </script>
</body>
</html>
