<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robringer Social Platform - Real Usernames</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
/* 2012 ROBLOX STYLE MODIFICATIONS (Tailwind integration where possible, plus custom CSS) */
        body {
            font-family: Verdana, sans-serif;
            background: #e4e7ec; 
        }
        
        /* --- Header --- */
        header {
            background: linear-gradient(to bottom, #00A3EF 0%, #0077CC 100%);
            border-bottom: 2px solid #005696;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        
        .robux-icon {
            background-color: #ffd700;
            border: 1px solid #CC9900;
        }

        .tab { display: none; }
        .active { display: block; }

        /* --- Custom Modal Styling (Fixing alert/confirm) --- */
        .custom-modal {
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); 
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            border: 1px solid #888;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            border-radius: 6px;
            border-top: 5px solid #0077CC;
        }
        .modal-title {
            background-color: #0077CC;
            color: white;
            padding: 10px;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }
        .modal-body {
            padding: 15px;
        }

        /* --- Input/Button Styling --- */
        .roblox-button {
            background: linear-gradient(to bottom, #7d7d7d 0%, #444444 100%);
            color: white;
            border: 1px solid #111;
            padding: 6px 12px;
            border-radius: 4px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 0 1px 2px rgba(0,0,0,0.5);
            font-weight: bold;
            text-shadow: 0 -1px 0 rgba(0,0,0,0.3);
            cursor: pointer;
            transition: background 0.1s;
        }
        .roblox-button:hover {
            background: linear-gradient(to bottom, #999999 0%, #555555 100%);
        }
        .roblox-button.primary {
            background: linear-gradient(to bottom, #5cb85c 0%, #449d44 100%);
            border-color: #398439;
        }
        .roblox-button.primary:hover {
            background: linear-gradient(to bottom, #6cd86c 0%, #55ad55 100%);
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="p-3">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <!-- Logo -->
            <a href="#" onclick="switchTab('home')" class="text-white text-2xl font-bold italic mr-6">ROBRINGER</a>

            <!-- Navigation Links (Centered) -->
            <nav class="flex-grow">
                <ul class="flex space-x-4 justify-center">
                    <li><a href="#" data-tab="home" onclick="switchTab('home')" class="nav-link text-white font-bold hover:text-yellow-200 transition p-2 rounded-t active-link">Home</a></li>
                    <li><a href="#" data-tab="games" onclick="switchTab('games')" class="nav-link text-white font-bold hover:text-yellow-200 transition p-2 rounded-t">Games</a></li>
                    <li><a href="#" data-tab="character" onclick="switchTab('character')" class="nav-link text-white font-bold hover:text-yellow-200 transition p-2 rounded-t">Character</a></li>
                    <li><a href="#" data-tab="catalog" onclick="switchTab('catalog')" class="nav-link text-white font-bold hover:text-yellow-200 transition p-2 rounded-t">Catalog</a></li>
                    <li><a href="#" data-tab="profile" onclick="switchTab('profile')" class="nav-link text-white font-bold hover:text-yellow-200 transition p-2 rounded-t">Profile</a></li>
                    <li><a href="#" data-tab="friends" onclick="switchTab('friends')" class="nav-link text-white font-bold hover:text-yellow-200 transition p-2 rounded-t">Friends</a></li>
                    <li><a href="#" data-tab="messages" onclick="switchTab('messages')" class="nav-link text-white font-bold hover:text-yellow-200 transition p-2 rounded-t">Messages</a></li>
                    <li><a href="#" data-tab="forum" onclick="switchTab('forum')" class="nav-link text-white font-bold hover:text-yellow-200 transition p-2 rounded-t">Forum</a></li>
                </ul>
            </nav>

            <!-- User Info (Right) -->
            <div class="flex items-center space-x-4">
                <div id="userInfo" class="text-white text-sm font-semibold flex items-center space-x-2">
                    <!-- User details will be rendered here -->
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4">
        <!-- Home Tab -->
        <div id="homeTab" class="tab active">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Welcome to Robringer!</h1>
            <p class="mb-4">Log in with a username to join the fun. This is a simplified version of a classic social gaming platform.</p>
            <div id="usernameSection" class="bg-white p-6 rounded shadow-md border border-gray-300">
                <h2 class="text-xl font-semibold mb-3">Choose a Username</h2>
                <input type="text" id="usernameInput" placeholder="Enter desired username" class="p-2 border border-gray-400 rounded w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="loginButton" class="roblox-button primary w-full" onclick="handleLogin()">Set Username</button>
                <p id="loginMessage" class="mt-3 text-sm text-red-600"></p>
            </div>

            <div class="mt-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Latest Updates</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded shadow border border-gray-300">
                        <h3 class="font-bold text-lg text-blue-700">New Games Page!</h3>
                        <p class="text-sm">Check out the revamped Games tab to find the most popular community creations.</p>
                    </div>
                    <div class="bg-white p-4 rounded shadow border border-gray-300">
                        <h3 class="font-bold text-lg text-blue-700">Catalog Refresh</h3>
                        <p class="text-sm">Hundreds of new items added to the Character Catalog! Spend those Robux!</p>
                    </div>
                    <div class="bg-white p-4 rounded shadow border border-gray-300">
                        <h3 class="font-bold text-lg text-blue-700">Forum Live!</h3>
                        <p class="text-sm">Start a discussion, ask questions, and connect with other users in the new Forum.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Games Tab -->
        <div id="gamesTab" class="tab">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Popular Games</h1>
            <div id="gamesList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Game cards will be loaded here -->
            </div>
            <div class="mt-6 p-4 bg-gray-200 rounded shadow border border-gray-300">
                <h2 class="text-xl font-semibold mb-2">Submit Your Game (Coming Soon!)</h2>
                <p>Developers will be able to add their own creations here.</p>
            </div>
        </div>

        <!-- Character Tab -->
        <div id="characterTab" class="tab">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Character Editor</h1>
            <div class="flex flex-col md:flex-row gap-6">
                <!-- 3D View (Mock) -->
                <div class="md:w-1/2 bg-gray-900 h-96 rounded shadow-xl flex items-center justify-center border-4 border-gray-700 relative">
                    <span id="characterDisplay" class="text-8xl p-8" style="filter: drop-shadow(0 0 10px #fff);"><!-- Character Display (e.g., emojis based on outfit) --></span>
                    <div class="absolute top-2 right-2 text-white text-xs bg-black bg-opacity-50 p-1 rounded">3D Preview</div>
                </div>
                <!-- Controls -->
                <div class="md:w-1/2 bg-white p-6 rounded shadow border border-gray-300">
                    <h2 class="text-xl font-semibold mb-4">Customize Appearance</h2>
                    
                    <label class="block mb-2 font-semibold">Hat:</label>
                    <select id="hatSelect" class="p-2 border border-gray-400 rounded w-full mb-4"></select>

                    <label class="block mb-2 font-semibold">Shirt:</label>
                    <select id="shirtSelect" class="p-2 border border-gray-400 rounded w-full mb-4"></select>
                    
                    <label class="block mb-2 font-semibold">Pants:</label>
                    <select id="pantsSelect" class="p-2 border border-gray-400 rounded w-full mb-4"></select>
                    
                    <button class="roblox-button primary w-full" onclick="saveCharacter()">Save Appearance</button>
                </div>
            </div>
        </div>

        <!-- Catalog Tab -->
        <div id="catalogTab" class="tab">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Character Catalog</h1>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Items for Sale</h2>
                <div id="userCurrency" class="flex items-center robux-icon rounded-full p-2 shadow-inner font-bold text-gray-800">
                    <!-- Robux amount here -->
                </div>
            </div>
            <div id="catalogList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <!-- Catalog items will be loaded here -->
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profileTab" class="tab">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Your Profile</h1>
            <div id="profileContent" class="bg-white p-6 rounded shadow border border-gray-300">
                <!-- Profile details, inventory, and description will be loaded here -->
            </div>
        </div>

        <!-- Friends Tab -->
        <div id="friendsTab" class="tab">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Friends List</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Friend Requests -->
                <div class="md:col-span-1 bg-white p-4 rounded shadow border border-gray-300">
                    <h2 class="text-xl font-semibold mb-3">Pending Requests</h2>
                    <div id="friendRequestsList" class="space-y-2">
                        <p class="text-sm text-gray-500">No pending requests.</p>
                    </div>
                </div>
                <!-- Current Friends -->
                <div class="md:col-span-2 bg-white p-4 rounded shadow border border-gray-300">
                    <h2 class="text-xl font-semibold mb-3">My Friends</h2>
                    <div id="friendsListContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <p class="text-sm text-gray-500">No friends yet. Find some users on the forum!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Tab -->
        <div id="messagesTab" class="tab">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Private Messages</h1>
            <div class="flex h-[60vh] bg-white rounded shadow border border-gray-300">
                <!-- User List -->
                <div class="w-1/3 border-r p-4 overflow-y-auto">
                    <h2 class="font-semibold text-lg mb-3 border-b pb-2">Users Online</h2>
                    <div id="onlineUsersList" class="space-y-2">
                        <!-- User items will be rendered here -->
                    </div>
                </div>
                <!-- Chat Window -->
                <div class="w-2/3 flex flex-col">
                    <div id="chatWindowHeader" class="p-3 border-b bg-gray-50 font-bold">
                        Select a user to start chatting...
                    </div>
                    <div id="chatMessages" class="flex-grow p-4 overflow-y-auto space-y-3">
                        <!-- Messages will be rendered here -->
                    </div>
                    <div id="chatInputArea" class="p-4 border-t flex space-x-2">
                        <input type="text" id="messageInput" placeholder="Type your message..." class="p-2 border border-gray-400 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                        <button class="roblox-button primary" onclick="sendMessage()" disabled id="sendMessageButton">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Forum Tab -->
        <div id="forumTab" class="tab">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Community Forum</h1>
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Topic List -->
                <div class="md:w-1/3 bg-white p-4 rounded shadow border border-gray-300">
                    <h2 class="text-xl font-semibold mb-4">Start a New Topic</h2>
                    <input type="text" id="newTopicTitle" placeholder="Topic Title" class="p-2 border border-gray-400 rounded w-full mb-2">
                    <textarea id="newTopicContent" placeholder="Topic Content..." rows="3" class="p-2 border border-gray-400 rounded w-full mb-3"></textarea>
                    <button class="roblox-button primary w-full" onclick="postNewTopic()">Post Topic</button>

                    <h2 class="text-xl font-semibold mt-6 mb-3 border-t pt-4">Topics</h2>
                    <div id="forumTopicsList" class="space-y-2">
                        <!-- Topics will be loaded here -->
                    </div>
                </div>
                <!-- Selected Topic Discussion -->
                <div class="md:w-2/3 bg-white p-6 rounded shadow border border-gray-300 flex flex-col">
                    <div id="forumDiscussion" class="flex-grow overflow-y-auto space-y-4">
                        <p class="text-gray-500">Select a topic from the left to view the discussion.</p>
                        <!-- Discussion posts will be rendered here -->
                    </div>
                    <div id="forumReplyArea" class="mt-4 border-t pt-4">
                        <h3 class="font-semibold mb-2">Reply</h3>
                        <textarea id="replyContent" placeholder="Post your reply..." rows="2" class="p-2 border border-gray-400 rounded w-full mb-3" disabled></textarea>
                        <button class="roblox-button primary" onclick="postReply()" disabled id="postReplyButton">Post Reply</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Tab (Hidden by default) -->
        <div id="adminTab" class="tab">
            <h1 class="text-3xl font-bold text-red-600 mb-6">Admin Panel</h1>
            <div id="adminContent" class="bg-white p-6 rounded shadow border border-gray-300">
                <p>Admin tools will be here.</p>
            </div>
        </div>
    </main>

    <!-- Custom Alert/Confirm Modal -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-title">
                <h3 id="modalTitle" class="font-bold text-lg">Alert</h3>
            </div>
            <div class="modal-body">
                <p id="modalMessage" class="mb-4 text-gray-700"></p>
                <div id="modalActions" class="flex justify-end space-x-3">
                    <button id="modalConfirm" class="roblox-button primary" style="display:none;">Confirm</button>
                    <button id="modalClose" class="roblox-button" onclick="closeModal()">Close</button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Firebase Imports (Updated to 12.6.0) ---
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, arrayUnion, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        setLogLevel('error');

        // --- Configuration and Global State ---

        // User's hardcoded Firebase configuration (used as a fallback)
        const hardcodedFirebaseConfig = {
            apiKey: "AIzaSyCJhGYm76p2N7_r_7ADqblDl1ajf4yI78c",
            authDomain: "robringer.firebaseapp.com",
            projectId: "robringer",
            storageBucket: "robringer.firebasestorage.app",
            messagingSenderId: "815804487038",
            appId: "1:815804487038:web:9dabdedce18e67fdd44f2f",
            measurementId: "G-G226T77ZBK"
        };
        
        let firebaseConfig;
        
        // 1. Attempt to load config from environment variable __firebase_config first (for sandbox reliability)
        if (typeof __firebase_config !== 'undefined') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Failed to parse __firebase_config, falling back to hardcoded config.", e);
                firebaseConfig = hardcodedFirebaseConfig;
            }
        } else {
            // 2. Fallback to user-provided hardcoded config
            firebaseConfig = hardcodedFirebaseConfig;
        }

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentUser = {
            uid: null,
            username: 'Guest',
            robux: 100,
            inventory: [],
            outfit: { hat: 'None', shirt: 'None', pants: 'None' },
            description: 'Hello, I am a new user!',
            isAdmin: false,
            lastSeen: new Date()
        };
        let isAuthReady = false;
        let currentTab = 'home';
        let selectedChatUser = null;
        let activeTopicId = null;
        let onlineUsers = [];
        let allGames = [];
        let allCatalog = [];
        let userFriends = [];

        // --- Utility Functions ---

        /** Custom Modal for Alerts and Confirms */
        function customAlert(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalConfirm').style.display = 'none';
            document.getElementById('modalClose').textContent = 'Close';
            document.getElementById('modalClose').onclick = closeModal;
            document.getElementById('customModal').style.display = 'flex';
        }

        function customConfirm(title, message) {
            return new Promise(resolve => {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('modalConfirm').style.display = 'inline-block';
                document.getElementById('modalConfirm').textContent = 'Confirm';
                document.getElementById('modalClose').textContent = 'Cancel';

                document.getElementById('modalConfirm').onclick = () => {
                    closeModal();
                    resolve(true);
                };
                document.getElementById('modalClose').onclick = () => {
                    closeModal();
                    resolve(false);
                };
                document.getElementById('customModal').style.display = 'flex';
            });
        }

        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
        }

        /** Firebase Path Helpers **/
        const getUserDocRef = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'data', 'profile');
        const getGameCollectionRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'games');
        const getCatalogCollectionRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'catalog');
        const getOnlineUsersCollectionRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'onlineUsers');
        const getFriendRequestsCollectionRef = (uid) => collection(db, 'artifacts', appId, 'users', uid, 'data', 'friendRequests');
        const getFriendsDocRef = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'data', 'friends');
        const getMessagesCollectionRef = (user1, user2) => {
            const path = [user1, user2].sort().join('_'); // Unique sorted ID for the conversation
            return collection(db, 'artifacts', appId, 'public', 'data', 'messages', path, 'messages');
        };
        const getTopicsCollectionRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'forumTopics');
        const getRepliesCollectionRef = (topicId) => collection(db, 'artifacts', appId, 'public', 'data', 'forumTopics', topicId, 'replies');

        // --- Authentication and User State Management ---

        /** Initializes Firebase and attempts to sign in. */
        async function signIn() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Initialize analytics
                if (firebaseConfig.measurementId) {
                    const analytics = getAnalytics(app); 
                }
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up auth state change listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser.uid = user.uid;
                        await loadUserProfile(user.uid);
                    } else {
                        // Signed out or Anonymous
                        currentUser.uid = null;
                        currentUser.username = 'Guest';
                        currentUser.isAdmin = false;
                        updateUI();
                        isAuthReady = true;
                    }
                    isAuthReady = true;
                    // Start real-time listeners only after auth is ready
                    startRealtimeListeners();
                });

            } catch (error) {
                console.error("Firebase Sign-In Error:", error);
                isAuthReady = true;
                // Display the specific Firebase error message
                customAlert('System Error', `Could not initialize Firebase or sign in. Error: ${error.code}. See console for details.`);
            }
        }

        /** Loads user profile or creates a default one. */
        async function loadUserProfile(uid) {
            if (!uid) return;
            const profileRef = getUserDocRef(uid);
            const profileSnap = await getDoc(profileRef);

            if (profileSnap.exists()) {
                const data = profileSnap.data();
                currentUser = {
                    ...currentUser,
                    ...data,
                    uid: uid,
                    username: data.username || 'Guest', // Ensure username exists
                    isAdmin: data.isAdmin || false,
                    inventory: data.inventory || [],
                    outfit: data.outfit || { hat: 'None', shirt: 'None', pants: 'None' },
                    description: data.description || 'Hello, I am a new user!'
                };
            } else {
                // Create a default profile for a newly signed-in anonymous user
                const defaultProfile = {
                    username: 'Guest',
                    robux: 100,
                    inventory: [],
                    outfit: { hat: 'None', shirt: 'None', pants: 'None' },
                    description: 'Hello, I am a new user!',
                    isAdmin: false,
                    joined: serverTimestamp(),
                    lastSeen: serverTimestamp()
                };
                currentUser = { ...currentUser, ...defaultProfile, uid: uid };
                await setDoc(profileRef, defaultProfile);
            }
            updateUI();
        }

        /** Handles setting a permanent username for the 'Guest' user. */
        async function handleLogin() {
            if (!isAuthReady || !currentUser.uid) {
                return customAlert('Wait', 'Please wait for the system to initialize.');
            }

            const usernameInput = document.getElementById('usernameInput').value.trim();
            const loginMessage = document.getElementById('loginMessage');

            if (!usernameInput) {
                loginMessage.textContent = 'Username cannot be empty.';
                return;
            }
            if (usernameInput.toLowerCase() === 'guest' || usernameInput.length < 3) {
                loginMessage.textContent = 'Username must be at least 3 characters and cannot be "Guest".';
                return;
            }

            try {
                // Use a transaction to ensure uniqueness
                await runTransaction(db, async (transaction) => {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'usernames'), where('username', '==', usernameInput));
                    const usernameSnap = await getDocs(q);

                    if (!usernameSnap.empty) {
                        throw new Error("This username is already taken. Try another one.");
                    }

                    // 1. Update the user's profile with the new username
                    const profileRef = getUserDocRef(currentUser.uid);
                    transaction.update(profileRef, { username: usernameInput });

                    // 2. Add the username to the public list
                    transaction.add(collection(db, 'artifacts', appId, 'public', 'data', 'usernames'), {
                        uid: currentUser.uid,
                        username: usernameInput,
                        searchableUsername: usernameInput.toLowerCase()
                    });

                    // 3. Update the local state
                    currentUser.username = usernameInput;
                });

                loginMessage.textContent = `Welcome, ${usernameInput}!`;
                loginMessage.classList.remove('text-red-600');
                loginMessage.classList.add('text-green-600');
                
                // Hide the login section
                document.getElementById('usernameSection').style.display = 'none';

                updateUI();
                customAlert('Success', `Your username is now set to ${usernameInput}.`);

            } catch (e) {
                console.error("Login Error:", e);
                loginMessage.textContent = e.message || 'An unexpected error occurred during login.';
                loginMessage.classList.remove('text-green-600');
                loginMessage.classList.add('text-red-600');
            }
        }

        /** Updates the main UI elements (header, etc.). */
        function updateUI() {
            const userInfoDiv = document.getElementById('userInfo');
            const currencyDiv = document.getElementById('userCurrency');

            // Header UI
            userInfoDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-xs">User ID:</span>
                    <span class="font-mono text-sm">${currentUser.uid || 'N/A'}</span>
                </div>
                <span class="font-bold text-lg">${currentUser.username}</span>
            `;
            
            // Catalog/Currency UI
            if (currencyDiv) {
                 currencyDiv.innerHTML = `
                    <span class="text-xl mr-1">R$</span>
                    <span class="text-xl">${currentUser.robux}</span>
                `;
            }

            // Home Tab visibility
            if (currentUser.username === 'Guest') {
                 document.getElementById('usernameSection').style.display = 'block';
                 document.getElementById('loginButton').disabled = !isAuthReady;
            } else {
                 document.getElementById('usernameSection').style.display = 'none';
            }

            // Admin Tab visibility
            document.querySelector('[data-tab="admin"]')?.classList.toggle('hidden', !currentUser.isAdmin);
        }

        // --- Realtime Listeners ---

        /** Sets up all necessary onSnapshot listeners. */
        function startRealtimeListeners() {
            if (!isAuthReady || !currentUser.uid) return;

            // 1. Listen for current user profile changes (for Robux, Admin status, etc.)
            const userRef = getUserDocRef(currentUser.uid);
            onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentUser = {
                        ...currentUser,
                        ...data,
                        inventory: data.inventory || [],
                        outfit: data.outfit || { hat: 'None', shirt: 'None', pants: 'None' },
                        isAdmin: data.isAdmin || false,
                        robux: data.robux || 0
                    };
                    updateUI();
                    if (currentTab === 'character') initCharacterEditor(); // Re-render if character editor is open
                    if (currentTab === 'profile') renderProfile(); // Re-render profile
                }
            }, (error) => console.error("Error listening to profile:", error));
            
            // 2. Listen for online users
            onSnapshot(getOnlineUsersCollectionRef(), (snapshot) => {
                onlineUsers = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                if (currentTab === 'messages') renderOnlineUsers();
            }, (error) => console.error("Error listening to online users:", error));

            // 3. Listen for catalog items
            onSnapshot(getCatalogCollectionRef(), (snapshot) => {
                allCatalog = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.price - a.price);
                if (currentTab === 'catalog') renderCatalog();
            }, (error) => console.error("Error listening to catalog:", error));

            // 4. Listen for friend list changes
            const friendsRef = getFriendsDocRef(currentUser.uid);
            onSnapshot(friendsRef, (docSnap) => {
                userFriends = docSnap.exists() ? docSnap.data().friends || [] : [];
                if (currentTab === 'friends') renderFriends();
            }, (error) => console.error("Error listening to friends:", error));

            // 5. Listen for forum topics
            onSnapshot(getTopicsCollectionRef(), (snapshot) => {
                const topics = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
                renderForumTopics(topics);
            }, (error) => console.error("Error listening to forum topics:", error));
            
            // 6. Start the online status update loop
            setInterval(updateOnlineStatus, 30000); // Every 30 seconds
            updateOnlineStatus(); // Initial call
        }

        /** Updates the user's lastSeen timestamp to keep them 'online'. */
        async function updateOnlineStatus() {
            if (!currentUser.uid || currentUser.username === 'Guest') return;
            try {
                const onlineRef = doc(getOnlineUsersCollectionRef(), currentUser.uid);
                await setDoc(onlineRef, {
                    username: currentUser.username,
                    lastSeen: serverTimestamp(),
                    isAdmin: currentUser.isAdmin
                });
            } catch (e) {
                console.warn("Could not update online status:", e);
            }
        }

        // --- Tab Content Rendering ---

        // Games Tab
        function loadGames() {
            if (!isAuthReady) return;
            const gamesList = document.getElementById('gamesList');
            gamesList.innerHTML = '<p class="col-span-4 text-center text-gray-500">Loading games...</p>';

            // Listen for changes to public game list
            onSnapshot(getGameCollectionRef(), (snapshot) => {
                allGames = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.players - a.players);
                renderGamesList();
            }, (error) => {
                console.error("Error loading games:", error);
                gamesList.innerHTML = '<p class="col-span-4 text-center text-red-500">Failed to load games.</p>';
            });
        }

        function renderGamesList() {
            const gamesList = document.getElementById('gamesList');
            if (currentTab !== 'games') return;
            
            if (allGames.length === 0) {
                gamesList.innerHTML = '<p class="col-span-4 text-center text-gray-500">No games available yet. Check back soon!</p>';
                return;
            }

            gamesList.innerHTML = allGames.map(game => `
                <div class="bg-white p-4 rounded shadow border border-gray-300 transition duration-150 hover:shadow-lg">
                    <div class="h-24 bg-gray-200 rounded mb-3 flex items-center justify-center text-4xl text-blue-500">${game.icon}</div>
                    <h3 class="font-bold text-lg">${game.title}</h3>
                    <p class="text-sm text-gray-600 mb-2">${game.creator}</p>
                    <p class="text-xs text-green-600 mb-3">${game.players} playing now</p>
                    <button class="roblox-button primary w-full text-xs" onclick="customAlert('Game Launch', 'Launching ${game.title}...');">Play Now</button>
                </div>
            `).join('');
        }
        
        // Character Editor Tab
        const itemOptions = {
            Hat: ['None', 'Top Hat üé©', 'Fedora üëí', 'Beanie üß¢', 'Crown üëë'],
            Shirt: ['None', 'T-Shirt üëï', 'Jacket üß•', 'Armor üõ°Ô∏è'],
            Pants: ['None', 'Jeans üëñ', 'Shorts ü©≥', 'Skirt üëó']
        };

        function initCharacterEditor() {
            if (currentTab !== 'character') return;

            ['Hat', 'Shirt', 'Pants'].forEach(type => {
                const select = document.getElementById(`${type.toLowerCase()}Select`);
                if (!select) return; // Guard
                
                // Clear existing options
                select.innerHTML = ''; 

                // Add all possible items for this type
                itemOptions[type].forEach(item => {
                    // Only show items the user owns (or 'None'), or the currently equipped item
                    if (item === 'None' || currentUser.inventory.includes(item) || currentUser.outfit[type.toLowerCase()] === item) {
                         const option = document.createElement('option');
                         option.value = item;
                         option.textContent = item;
                         if (currentUser.outfit[type.toLowerCase()] === item) {
                             option.selected = true;
                         }
                         select.appendChild(option);
                    }
                });
                
                // Add event listener to update preview immediately
                select.onchange = updateCharacterPreview;
            });
            
            updateCharacterPreview();
        }
        
        function updateCharacterPreview() {
            const hat = document.getElementById('hatSelect')?.value || currentUser.outfit.hat;
            const shirt = document.getElementById('shirtSelect')?.value || currentUser.outfit.shirt;
            const pants = document.getElementById('pantsSelect')?.value || currentUser.outfit.pants;
            
            const characterDisplay = document.getElementById('characterDisplay');
            
            // Generate a simple emoji representation based on the selected items
            let emojis = '';
            if (hat && hat !== 'None') emojis += hat.split(' ')[1] || 'üßë‚Äç'; // Use the emoji part
            emojis += 'üßç'; // Base character
            if (shirt && shirt !== 'None') emojis += shirt.split(' ')[1] || '';
            if (pants && pants !== 'None') emojis += pants.split(' ')[1] || '';
            
            // Fallback for visual appeal
            if (emojis.length < 2) emojis = 'üßç'; 

            characterDisplay.textContent = emojis;
        }

        async function saveCharacter() {
            if (!currentUser.uid || currentUser.username === 'Guest') return customAlert('Error', 'Please log in to save your character.');
            
            const newOutfit = {
                hat: document.getElementById('hatSelect').value,
                shirt: document.getElementById('shirtSelect').value,
                pants: document.getElementById('pantsSelect').value
            };
            
            try {
                const profileRef = getUserDocRef(currentUser.uid);
                await updateDoc(profileRef, { outfit: newOutfit });
                currentUser.outfit = newOutfit;
                customAlert('Success', 'Your character appearance has been saved!');
            } catch (e) {
                console.error("Error saving character:", e);
                customAlert('Error', 'Failed to save character. Please try again.');
            }
        }

        // Catalog Tab
        function renderCatalog() {
            if (currentTab !== 'catalog') return;
            const catalogList = document.getElementById('catalogList');
            
            if (allCatalog.length === 0) {
                 catalogList.innerHTML = '<p class="col-span-5 text-center text-gray-500">No items in the catalog yet.</p>';
                 return;
            }

            catalogList.innerHTML = allCatalog.map(item => `
                <div class="bg-white p-3 rounded shadow border border-gray-300 flex flex-col justify-between">
                    <div class="h-16 bg-gray-100 rounded mb-2 flex items-center justify-center text-3xl">${item.icon}</div>
                    <h3 class="font-bold text-sm truncate" title="${item.name}">${item.name}</h3>
                    <p class="text-xs text-gray-600">${item.type}</p>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-sm font-bold flex items-center robux-icon rounded-full px-2 py-0.5">${item.price} R$</span>
                        ${currentUser.inventory.includes(item.name) ? 
                            '<button class="roblox-button text-xs opacity-70 cursor-default">Owned</button>' :
                            `<button class="roblox-button primary text-xs" onclick="buyItem('${item.id}', '${item.name}', ${item.price})">Buy</button>`
                        }
                    </div>
                </div>
            `).join('');
        }
        
        async function buyItem(itemId, itemName, price) {
            if (!currentUser.uid || currentUser.username === 'Guest') return customAlert('Error', 'Please log in to make purchases.');
            if (currentUser.inventory.includes(itemName)) return customAlert('Error', 'You already own this item.');
            if (currentUser.robux < price) return customAlert('Error', `You need ${price - currentUser.robux} more R$ to buy this.`);
            
            const confirmed = await customConfirm('Confirm Purchase', `Do you want to buy ${itemName} for ${price} R$?`);
            if (!confirmed) return;

            try {
                await runTransaction(db, async (transaction) => {
                    const profileRef = getUserDocRef(currentUser.uid);
                    const profileSnap = await transaction.get(profileRef);

                    if (!profileSnap.exists()) throw new Error("Profile not found.");
                    
                    const currentRobux = profileSnap.data().robux || 0;
                    const currentInventory = profileSnap.data().inventory || [];

                    if (currentRobux < price) throw new Error("Insufficient Robux.");
                    if (currentInventory.includes(itemName)) throw new Error("Already owned.");

                    // Deduct Robux and add to inventory
                    transaction.update(profileRef, {
                        robux: currentRobux - price,
                        inventory: arrayUnion(itemName)
                    });
                });

                customAlert('Success!', `${itemName} has been added to your inventory.`);
                // Listener will update currentUser and re-render the catalog
            } catch (e) {
                console.error("Purchase Error:", e);
                customAlert('Purchase Failed', e.message || 'An unexpected error occurred during the transaction.');
            }
        }

        // Profile Tab
        function renderProfile() {
             if (currentTab !== 'profile') return;
             const profileContent = document.getElementById('profileContent');

             profileContent.innerHTML = `
                 <div class="flex items-center mb-6 border-b pb-4">
                     <div class="h-24 w-24 bg-gray-200 rounded-full flex items-center justify-center text-5xl mr-4">${currentUser.outfit.hat === 'Crown üëë' ? 'üëë' : 'üßë‚Äç'}</div>
                     <div>
                         <h2 class="text-3xl font-bold text-blue-700">${currentUser.username}</h2>
                         <p class="text-sm text-gray-500">User ID: ${currentUser.uid}</p>
                         <div class="flex items-center mt-1 robux-icon rounded-full px-3 py-1 shadow-inner font-bold text-gray-800 text-lg">
                            <span class="mr-1">R$</span>
                            <span>${currentUser.robux}</span>
                         </div>
                     </div>
                 </div>

                 <div class="mb-6">
                     <h3 class="text-xl font-semibold mb-2">About Me</h3>
                     <textarea id="descriptionInput" class="p-2 border border-gray-400 rounded w-full h-24 mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">${currentUser.description}</textarea>
                     <button class="roblox-button primary" onclick="saveDescription()">Save Description</button>
                 </div>

                 <div class="mb-6">
                     <h3 class="text-xl font-semibold mb-2">Equipped Outfit</h3>
                     <p class="text-sm">Hat: <strong>${currentUser.outfit.hat}</strong></p>
                     <p class="text-sm">Shirt: <strong>${currentUser.outfit.shirt}</strong></p>
                     <p class="text-sm">Pants: <strong>${currentUser.outfit.pants}</strong></p>
                 </div>
                 
                 <div>
                     <h3 class="text-xl font-semibold mb-2">Inventory (${currentUser.inventory.length})</h3>
                     <p class="text-sm text-gray-700">${currentUser.inventory.join(', ') || 'No items owned.'}</p>
                 </div>
             `;
        }

        async function saveDescription() {
            if (!currentUser.uid || currentUser.username === 'Guest') return customAlert('Error', 'Please log in to update your profile.');
            const newDescription = document.getElementById('descriptionInput').value.trim();
            
            try {
                 const profileRef = getUserDocRef(currentUser.uid);
                 await updateDoc(profileRef, { description: newDescription });
                 currentUser.description = newDescription; // Update local state immediately
                 customAlert('Success', 'Your description has been updated!');
             } catch (e) {
                 console.error("Error saving description:", e);
                 customAlert('Error', 'Failed to save description. Please try again.');
             }
        }
        
        // Friends Tab
        async function renderFriends() {
            if (currentTab !== 'friends') return;
            const requestsList = document.getElementById('friendRequestsList');
            const friendsContainer = document.getElementById('friendsListContainer');
            
            // 1. Render Requests (Requires a separate listener/fetch, but for simplicity, we'll fetch once here)
            // In a full app, you'd use a listener here.
            try {
                const q = query(getFriendRequestsCollectionRef(currentUser.uid), where('status', '==', 'pending'));
                const snapshot = await getDocs(q);
                const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (requests.length === 0) {
                    requestsList.innerHTML = '<p class="text-sm text-gray-500">No pending requests.</p>';
                } else {
                    requestsList.innerHTML = requests.map(req => `
                        <div class="flex justify-between items-center bg-gray-100 p-2 rounded">
                            <span class="font-semibold text-sm">${req.senderUsername}</span>
                            <div class="space-x-1">
                                <button class="roblox-button primary text-xs" onclick="handleFriendRequest('${req.id}', '${req.senderId}', true)">Accept</button>
                                <button class="roblox-button text-xs" onclick="handleFriendRequest('${req.id}', '${req.senderId}', false)">Decline</button>
                            </div>
                        </div>
                    `).join('');
                }

            } catch (e) {
                console.error("Error loading friend requests:", e);
                requestsList.innerHTML = '<p class="text-sm text-red-500">Error loading requests.</p>';
            }

            // 2. Render Friends List (Updated by realtime listener)
            if (userFriends.length === 0) {
                friendsContainer.innerHTML = '<p class="col-span-2 text-sm text-gray-500">No friends yet. Find some users on the forum!</p>';
            } else {
                friendsContainer.innerHTML = userFriends.map(friend => `
                    <div class="flex items-center bg-white p-3 rounded shadow border border-gray-300 justify-between">
                        <span class="font-bold text-blue-700">${friend.username}</span>
                        <div class="space-x-2">
                             <span class="text-xs text-green-600">${friend.status || 'Online'}</span>
                             <button class="roblox-button text-xs" onclick="removeFriend('${friend.uid}', '${friend.username}')">Unfriend</button>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        async function handleFriendRequest(requestId, senderId, accept) {
            if (!currentUser.uid) return;
            
            try {
                if (accept) {
                    await runTransaction(db, async (transaction) => {
                        const myFriendsRef = getFriendsDocRef(currentUser.uid);
                        const senderFriendsRef = getFriendsDocRef(senderId);

                        // 1. Add friend to my list
                        transaction.set(myFriendsRef, { friends: arrayUnion({ uid: senderId, username: (await getDoc(getUserDocRef(senderId))).data().username }) }, { merge: true });

                        // 2. Add me to sender's list
                        transaction.set(senderFriendsRef, { friends: arrayUnion({ uid: currentUser.uid, username: currentUser.username }) }, { merge: true });

                        // 3. Delete the request
                        transaction.delete(doc(getFriendRequestsCollectionRef(currentUser.uid), requestId));
                    });
                    customAlert('Accepted', 'Friend request accepted!');
                } else {
                    await deleteDoc(doc(getFriendRequestsCollectionRef(currentUser.uid), requestId));
                    customAlert('Declined', 'Friend request declined.');
                }
                renderFriends(); // Re-render the tab
            } catch (e) {
                console.error("Error handling friend request:", e);
                customAlert('Error', 'Failed to process request.');
            }
        }

        async function removeFriend(friendId, friendUsername) {
             const confirmed = await customConfirm('Unfriend', `Are you sure you want to remove ${friendUsername} from your friends?`);
             if (!confirmed) return;

             try {
                 await runTransaction(db, async (transaction) => {
                     const myFriendsRef = getFriendsDocRef(currentUser.uid);
                     const friendFriendsRef = getFriendsDocRef(friendId);
                     
                     // 1. Remove friend from my list (re-read, filter, and write back)
                     const myFriendsSnap = await transaction.get(myFriendsRef);
                     let newMyFriends = myFriendsSnap.exists() ? myFriendsSnap.data().friends.filter(f => f.uid !== friendId) : [];
                     transaction.set(myFriendsRef, { friends: newMyFriends });

                     // 2. Remove me from friend's list (re-read, filter, and write back)
                     const friendFriendsSnap = await transaction.get(friendFriendsRef);
                     let newFriendFriends = friendFriendsSnap.exists() ? friendFriendsSnap.data().friends.filter(f => f.uid !== currentUser.uid) : [];
                     transaction.set(friendFriendsRef, { friends: newFriendFriends });
                 });
                 customAlert('Success', `${friendUsername} has been unfriended.`);
             } catch (e) {
                 console.error("Error removing friend:", e);
                 customAlert('Error', 'Failed to remove friend.');
             }
        }

        // Messages Tab
        function renderOnlineUsers() {
            if (currentTab !== 'messages') return;
            const list = document.getElementById('onlineUsersList');
            
            // Filter out self and guests
            const displayUsers = onlineUsers.filter(u => u.uid !== currentUser.uid && u.username !== 'Guest');
            
            if (displayUsers.length === 0) {
                 list.innerHTML = '<p class="text-sm text-gray-500">No other users currently online.</p>';
                 return;
            }

            list.innerHTML = displayUsers.map(user => `
                <div class="flex items-center p-2 rounded cursor-pointer hover:bg-blue-100 ${selectedChatUser?.uid === user.uid ? 'bg-blue-200' : 'bg-gray-50'}" onclick="selectChatUser('${user.uid}', '${user.username}')">
                    <span class="text-lg mr-2">${user.isAdmin ? '‚≠ê' : 'üí¨'}</span>
                    <span class="font-semibold text-sm">${user.username}</span>
                </div>
            `).join('');
        }
        
        function selectChatUser(uid, username) {
            selectedChatUser = { uid, username };
            
            // Update the UI
            document.getElementById('chatWindowHeader').textContent = `Chatting with: ${username}`;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendMessageButton').disabled = false;
            renderOnlineUsers(); // Re-render list to highlight selection
            
            // Start listening for messages
            renderChatMessages();
        }

        function renderChatMessages() {
             if (currentTab !== 'messages' || !selectedChatUser) {
                 document.getElementById('chatMessages').innerHTML = '<p class="text-center text-gray-500 mt-10">Select a user to start chatting...</p>';
                 document.getElementById('chatWindowHeader').textContent = 'Select a user to start chatting...';
                 document.getElementById('messageInput').disabled = true;
                 document.getElementById('sendMessageButton').disabled = true;
                 return;
             }

             const messagesDiv = document.getElementById('chatMessages');
             messagesDiv.innerHTML = '<p class="text-center text-gray-500">Loading messages...</p>';

             // Set up a listener for the specific conversation path
             const messagesRef = getMessagesCollectionRef(currentUser.uid, selectedChatUser.uid);
             const q = query(messagesRef, where('timestamp', '>', new Date(Date.now() - 36000000))); // Load last 10 hours for simplicity
             
             onSnapshot(messagesRef, (snapshot) => {
                 if (currentTab !== 'messages' || !selectedChatUser) return; // Guard against tab change
                 
                 const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate());
                 
                 messagesDiv.innerHTML = messages.map(msg => {
                     const isMine = msg.senderId === currentUser.uid;
                     const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                     
                     return `
                         <div class="flex ${isMine ? 'justify-end' : 'justify-start'}">
                             <div class="max-w-xs p-3 rounded-lg shadow ${isMine ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}">
                                 <p class="font-bold text-xs ${isMine ? 'text-blue-100' : 'text-gray-600'}">${msg.senderName}</p>
                                 <p class="text-sm">${msg.text}</p>
                                 <p class="text-right text-xs mt-1 ${isMine ? 'text-blue-200' : 'text-gray-500'}">${time}</p>
                             </div>
                         </div>
                     `;
                 }).join('');
                 
                 // Scroll to bottom
                 messagesDiv.scrollTop = messagesDiv.scrollHeight;
                 
             }, (error) => console.error("Error listening to messages:", error));
        }

        async function sendMessage() {
            if (!selectedChatUser || !currentUser.uid || currentUser.username === 'Guest') return customAlert('Error', 'Select a user and log in to send a message.');
            
            const input = document.getElementById('messageInput');
            const messageText = input.value.trim();
            
            if (!messageText) return;
            
            try {
                const messagesRef = getMessagesCollectionRef(currentUser.uid, selectedChatUser.uid);
                await addDoc(messagesRef, {
                    senderId: currentUser.uid,
                    senderName: currentUser.username,
                    text: messageText,
                    timestamp: serverTimestamp()
                });
                input.value = ''; // Clear input
            } catch (e) {
                console.error("Error sending message:", e);
                customAlert('Error', 'Failed to send message.');
            }
        }
        
        // Forum Tab
        function renderForumTopics(topics) {
            const list = document.getElementById('forumTopicsList');
            if (currentTab !== 'forum') return;
            
            list.innerHTML = topics.map(topic => `
                <div class="p-3 bg-gray-50 rounded border border-gray-200 cursor-pointer hover:bg-gray-100 ${topic.id === activeTopicId ? 'ring-2 ring-blue-500' : ''}" onclick="selectTopic('${topic.id}')">
                    <h4 class="font-bold text-sm">${topic.title}</h4>
                    <p class="text-xs text-gray-600">by ${topic.author} - ${topic.replyCount || 0} replies</p>
                </div>
            `).join('');
        }

        async function postNewTopic() {
            if (!currentUser.uid || currentUser.username === 'Guest') return customAlert('Error', 'Please log in to post a topic.');
            
            const titleInput = document.getElementById('newTopicTitle');
            const contentInput = document.getElementById('newTopicContent');
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            
            if (!title || !content) return customAlert('Validation', 'Title and content cannot be empty.');

            try {
                const topicsRef = getTopicsCollectionRef();
                await addDoc(topicsRef, {
                    title: title,
                    content: content,
                    authorId: currentUser.uid,
                    author: currentUser.username,
                    createdAt: serverTimestamp(),
                    replyCount: 0
                });
                
                titleInput.value = '';
                contentInput.value = '';
                customAlert('Success', 'New topic posted successfully!');
            } catch (e) {
                console.error("Error posting topic:", e);
                customAlert('Error', 'Failed to post topic.');
            }
        }

        async function selectTopic(topicId) {
            if (activeTopicId === topicId) return; // Avoid re-loading the same topic
            activeTopicId = topicId;
            
            const discussionDiv = document.getElementById('forumDiscussion');
            const replyButton = document.getElementById('postReplyButton');
            const replyContent = document.getElementById('replyContent');
            
            discussionDiv.innerHTML = '<p class="text-center text-gray-500 mt-10">Loading topic...</p>';
            replyButton.disabled = false;
            replyContent.disabled = false;
            
            try {
                // 1. Load Topic Content
                const topicSnap = await getDoc(doc(getTopicsCollectionRef(), topicId));
                if (!topicSnap.exists()) {
                    discussionDiv.innerHTML = '<p class="text-center text-red-500 mt-10">Topic not found.</p>';
                    return;
                }
                const topic = { id: topicSnap.id, ...topicSnap.data() };
                
                // 2. Load and listen for replies
                const repliesRef = getRepliesCollectionRef(topicId);
                
                onSnapshot(repliesRef, (snapshot) => {
                    if (topicId !== activeTopicId) return; // Guard for fast switching
                    
                    const replies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.createdAt.toDate() - b.createdAt.toDate());
                    const allPosts = [{ type: 'topic', ...topic }, ...replies.map(r => ({ type: 'reply', ...r }))];

                    discussionDiv.innerHTML = allPosts.map(post => {
                        const time = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleString() : 'Just now';
                        
                        if (post.type === 'topic') {
                            return `
                                <div class="p-4 bg-blue-50 border-2 border-blue-200 rounded shadow-md">
                                    <h3 class="text-2xl font-bold mb-2 text-blue-800">${post.title}</h3>
                                    <p class="text-sm text-gray-600 mb-3">Posted by <strong>${post.author}</strong> on ${time}</p>
                                    <p class="whitespace-pre-wrap">${post.content}</p>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="p-3 bg-white border border-gray-300 rounded shadow">
                                    <p class="text-xs text-gray-600 mb-1">Reply by <strong>${post.author}</strong> on ${time}</p>
                                    <p class="whitespace-pre-wrap">${post.content}</p>
                                </div>
                            `;
                        }
                    }).join('');

                    // Scroll to bottom
                    discussionDiv.scrollTop = discussionDiv.scrollHeight;
                }, (error) => console.error("Error listening to replies:", error));

            } catch (e) {
                console.error("Error selecting topic:", e);
                discussionDiv.innerHTML = '<p class="text-center text-red-500 mt-10">Failed to load topic details.</p>';
            }
        }
        
        async function postReply() {
            if (!activeTopicId || !currentUser.uid || currentUser.username === 'Guest') return customAlert('Error', 'Please log in and select a topic to reply.');
            
            const contentInput = document.getElementById('replyContent');
            const content = contentInput.value.trim();
            
            if (!content) return customAlert('Validation', 'Reply content cannot be empty.');

            try {
                // 1. Add reply to sub-collection
                const repliesRef = getRepliesCollectionRef(activeTopicId);
                await addDoc(repliesRef, {
                    content: content,
                    authorId: currentUser.uid,
                    author: currentUser.username,
                    createdAt: serverTimestamp()
                });
                
                // 2. Increment reply count on the main topic document
                const topicRef = doc(getTopicsCollectionRef(), activeTopicId);
                // Note: We use runTransaction for concurrency safety in a real app, but for a simple counter updateDoc with an optimistic read is used here for brevity. 
                // In this case, we'll re-read and increment to be safer since we aren't using FieldValue.increment (which isn't imported).
                const currentCount = (await getDoc(topicRef)).data().replyCount || 0;
                await updateDoc(topicRef, { replyCount: currentCount + 1 });
                
                contentInput.value = '';
                // Listener will automatically update the discussion view
            } catch (e) {
                console.error("Error posting reply:", e);
                customAlert('Error', 'Failed to post reply.');
            }
        }


        // Tab Switching Logic
        function switchTab(tabName) {
            // Block non-home tabs for guests
            if (tabName !== 'home' && currentUser.username === 'Guest') {
                 customAlert('Login Required', 'You must choose a username to access this page.');
                 return;
            }

            currentTab = tabName;
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active-link'));

            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active-link');

            // Specific tab loading logic
            if (tabName === 'games') loadGames();
            if (tabName === 'character') initCharacterEditor();
            if (tabName === 'profile') renderProfile();
            if (tabName === 'catalog') renderCatalog();
            if (tabName === 'friends') renderFriends();
            if (tabName === 'messages') renderChatMessages();
            if (tabName === 'forum') renderForumTopics([]); // Clear and trigger re-render of topics
            if (tabName === 'admin') loadAdminPanel();
        }
        window.switchTab = switchTab;
        
        // --- Initial Load Functions ---
        document.addEventListener('DOMContentLoaded', () => {
            // Start the sign-in process
            signIn(); 
            // Load default/public data initially
            loadGames(); 
        });
    </script>
</body>
</html>
